# リファクタリング計画: src ディレクトリ構造 [2025-05-13]

## 1. 現状分析

### 1.1 対象概要
src ディレクトリはVSCode拡張機能「AppGenius AI」のコアコードを含む主要ディレクトリで、拡張機能のエントリーポイント、UI コンポーネント、コアサービス、ユーティリティ、認証機能などを管理している。拡張機能全体の機能提供、UI 表示、バックエンドとの連携などを担う中心的な役割を果たしている。

### 1.2 問題点と課題
- **重複コードの存在**: 複数の認証システムが共存し、機能の重複が見られる
- **古いファイルの残存**: extension.ts.bak, extension.ts.saved, extension.ts.auth_fix_backup などの複数のバックアップファイルが不要に残されている
- **整理されていないサービス構造**: サービス間の依存関係が明確でなく、責任の分離が不十分
- **肥大化したファイル**: 特に extension.ts (約650行) が多数の機能を含み肥大化している
- **未使用コードが多い**: コメントアウトされた古いコード、未使用のサービスやコンポーネント（プロンプトライブラリなど）が散在
- **未使用のクラス/ファイル**: 実装はされているがどこからも参照されていない未使用クラス（GitManager, mockupGenerator, CodeGenerator など）が多数存在
- **構成ファイルが不明確**: どのファイルが必須でどのファイルが廃止予定なのかが不明瞭
- **ディレクトリ構造の不整合**: 同様の機能を持つコンポーネントが異なるディレクトリに分散している
- **認証システムの混在**: 「従来の認証システム」と「新しい認証システム」が並行して存在し、統合が不完全
- **グローバル変数の乱用**: global オブジェクトにインスタンスや状態を多数保存しており、状態管理が不透明

### 1.3 関連ファイル一覧
- src/extension.ts (メインエントリーポイント)
- src/extension.ts.* (バックアップファイル群)
- src/ext-fix.ts
- src/claude_code_counter_event_listener.ts
- src/core/auth/* (認証関連ファイル)
- src/services/* (各種サービス)
- src/ui/* (UI コンポーネント)
- src/utils/* (ユーティリティ)
- src/api/* (API クライアント)
- src/commands/* (コマンド登録)
- src/types/* (型定義)

### 1.4 依存関係図
```
extension.ts
├── core/
│   ├── auth/ (認証システム)
│   │   ├── SimpleAuthManager/Service (新認証)
│   │   └── PermissionManager (権限管理)
│   ├── aiService (AI 機能)
│   └── その他コアサービス
├── ui/
│   ├── ScopeManagerPanel (中心的 UI)
│   ├── FileViewerPanel
│   ├── auth/ (認証 UI)
│   └── その他 UI コンポーネント
├── services/
│   ├── AppGeniusEventBus (イベント管理)
│   ├── ProjectManagementService (プロジェクト管理)
│   └── その他サービス
├── utils/ (ユーティリティ機能)
├── api/ (API クライアント)
└── commands/ (コマンド登録)
```

## 2. リファクタリングの目標

### 2.1 期待される成果
- **コード量の削減**: 不要なバックアップファイルと未使用コードの削除により、コードベースを20%以上削減
- **メンテナンス性の向上**: 明確な責任分離と依存関係の整理により、変更の影響範囲を限定化
- **構造の明確化**: ディレクトリ構造とファイル命名の一貫性向上により、新規開発者の学習コストを低減
- **認証システムの統一**: 単一の認証システムに統合し、認証関連コードの重複を解消
- **状態管理の改善**: グローバル変数の使用を削減し、明示的な状態管理パターンを導入

### 2.2 維持すべき機能
- スコープマネージャー機能
- ファイルビューワー機能
- モックアップギャラリー
- 認証機能（SimpleAuth ベース）
- Claude Code との統合
- コマンド登録と実行機能
- プロジェクト管理機能

### 2.3 削除すべき機能
- プロンプトライブラリ機能（UIから参照されておらず未使用）
- SimpleChat（既に廃止済みでファイルビューワーへリダイレクトされている）
- 旧認証システム

## 3. 理想的な実装

### 3.1 全体アーキテクチャ
- **クリーンアーキテクチャ** の採用:
  - コア層: ビジネスロジックとドメインモデル
  - インフラ層: API クライアント、ストレージなど
  - アプリケーション層: ユースケース実装
  - UI 層: VSCode 拡張 UI コンポーネント
- 各層での明確な **依存方向の管理**:
  - 内側の層は外側の層に依存しない
  - 依存性の注入を活用した疎結合設計

### 3.2 核心的な改善ポイント
1. **単一認証システムへの統合**:
   - SimpleAuthManager/Service を唯一の認証システムとして確立
   - 従来の認証関連コードを完全に削除
   - 認証状態管理の一元化と明示的な API の提供

2. **拡張機能エントリーポイントの最小化**:
   - extension.ts の役割を「サービス初期化」と「コマンド登録」に限定
   - ビジネスロジックを適切なサービスに移動
   - 明示的な初期化順序と依存関係の管理

3. **イベントシステムの強化**:
   - AppGeniusEventBus を中心としたイベント駆動アーキテクチャ
   - 各コンポーネント間の通信を明示的なイベントに統一
   - グローバル変数への依存を削減

4. **サービスレジストリの導入**:
   - グローバルな依存性の代わりにサービスレジストリを使用
   - 各サービスのライフサイクル管理の統一
   - テスト容易性の向上

### 3.3 新しいディレクトリ構造
```
src/
├── extension.ts (シンプル化されたエントリーポイント)
├── api/ (API クライアント)
│   ├── claudeCodeApi.ts
│   └── portalApi.ts
├── commands/ (コマンド登録)
│   ├── authCommands.ts
│   └── fileViewerCommands.ts
├── core/ (ビジネスロジック)
│   ├── auth/ (単一認証システム)
│   │   ├── SimpleAuthManager.ts
│   │   ├── SimpleAuthService.ts
│   │   └── PermissionManager.ts
│   └── ai/
│       └── aiService.ts
├── services/ (アプリケーションサービス)
│   ├── eventBus/
│   │   └── AppGeniusEventBus.ts
│   ├── serviceRegistry.ts (サービスレジストリ)
│   ├── projectState/
│   │   └── ProjectStateService.ts
│   └── sharing/
│       └── ClaudeCodeSharingService.ts
├── ui/ (UI コンポーネント)
│   ├── auth/ (認証 UI)
│   ├── fileViewer/
│   ├── mockupGallery/
│   ├── scopeManager/
│   └── common/ (共通 UI コンポーネント)
├── types/ (型定義)
│   ├── auth.ts
│   ├── events.ts
│   ├── projects.ts
│   └── index.ts
└── utils/ (ユーティリティ)
    ├── logger.ts
    ├── fileSystem.ts
    ├── markdown.ts
    └── storage.ts
```

## 4. 実装計画

### フェーズ1: 不要ファイルの削除
- **目標**: コードベースのクリーンアップと整理
- **影響範囲**: src/ ディレクトリ全体
- **タスク**:
  1. **T1.1**: バックアップファイルの削除
     - 対象: src/extension.ts.saved, src/extension.ts.bak, src/extension.ts.auth_fix_backup など
     - 実装: `git rm` コマンドでファイルを削除
  2. **T1.2**: コメントアウトされた未使用コードの削除
     - 対象: src/extension.ts 内のコメントアウトセクション (行 406-481)
     - 実装: コメントアウトされたコードブロックを完全に削除
  3. **T1.3**: プロンプトライブラリ関連ファイルの削除
     - 対象: src/ui/promptLibrary/ ディレクトリ全体、src/commands/promptLibraryCommands.ts 
     - 実装: UIから参照されておらず使用されていないプロンプトライブラリ機能を完全に削除
  4. **T1.4**: 未使用クラスとファイルの削除
     - 対象: src/core/gitManager.ts, src/modes/requirementMode/mockupGenerator.ts, src/core/projectAnalyzer.ts
     - 実装: インポートのみされ実際には使われていない未使用クラスを削除
  5. **T1.5**: 未使用コード生成関連クラスの処理
     - 対象: src/core/codeGenerator.ts, src/modes/implementationMode/testGenerator.ts, src/modes/implementationMode/codeEditor.ts
     - 実装: これらのクラスはインポートされているが実際に使用されていないため削除し、関連するインポート文も削除
  6. **T1.6**: その他の未使用ディレクトリとファイルの特定と削除
     - 対象: SimpleChat関連のコードと使用されていないコンポーネントやサービス
     - 実装: 依存関係分析に基づいて未使用ファイルをリスト化し削除
- **検証ポイント**:
  - 削除後も拡張機能が正常に起動すること
  - すべての主要機能（認証、スコープマネージャー、ファイルビューワー）が動作すること
  - コンパイルエラーが発生しないこと

### フェーズ2: 認証システムの統合
- **目標**: シンプル認証システムへの完全移行
- **影響範囲**: src/core/auth/, src/ui/auth/, src/extension.ts
- **タスク**:
  1. **T2.1**: 従来の認証システム関連コードの削除
     - 対象: 古い認証関連のインポートとコード
     - 実装: extension.ts から古い認証システム参照を削除
  2. **T2.2**: SimpleAuthManager の強化
     - 対象: src/core/auth/SimpleAuthManager.ts
     - 実装: インターフェイスの明確化とエラーハンドリングの改善
  3. **T2.3**: 認証状態管理の一元化
     - 対象: src/core/auth/SimpleAuthService.ts
     - 実装: 状態管理の改善とイベント駆動パターンの強化
  4. **T2.4**: 認証 UI コンポーネントの整理
     - 対象: src/ui/auth/
     - 実装: 不要コンポーネントの削除と一貫性のあるインターフェイスの提供
- **検証ポイント**:
  - ログイン・ログアウト機能が正常に動作すること
  - 認証状態が正しく維持されること
  - 権限に基づくアクセス制御が機能すること

### フェーズ3: エントリーポイントの最適化
- **目標**: extension.ts の簡素化と責任分離
- **影響範囲**: src/extension.ts, src/services/
- **タスク**:
  1. **T3.1**: サービスレジストリの実装
     - 対象: 新規ファイル src/services/serviceRegistry.ts
     - 実装: サービスの依存性管理と初期化順序制御のための仕組みを提供
  2. **T3.2**: 肥大化した extension.ts の分割
     - 対象: src/extension.ts
     - 実装: 機能ごとに適切なサービスやモジュールに分離
  3. **T3.3**: コマンド登録の整理
     - 対象: src/commands/, src/extension.ts
     - 実装: コマンド登録ロジックを commands/ ディレクトリに集約
  4. **T3.4**: イベントリスナー登録の整理
     - 対象: src/extension.ts, src/services/AppGeniusEventBus.ts
     - 実装: イベントリスナー登録を各サービスの責任に変更
- **検証ポイント**:
  - 拡張機能が正常に起動・動作すること
  - すべてのコマンドが正常に登録され実行できること
  - サービスの初期化順序が正しく維持されること

### フェーズ4: サービス間依存関係の整理
- **目標**: 明確な責任分離と依存関係の確立
- **影響範囲**: src/services/, src/core/
- **タスク**:
  1. **T4.1**: AppGeniusEventBus の強化
     - 対象: src/services/eventBus/AppGeniusEventBus.ts
     - 実装: イベント型の定義と型安全なイベント通信の実装
  2. **T4.2**: サービス間の明示的依存関係設定
     - 対象: 各サービスのコンストラクタ
     - 実装: 依存性注入パターンの一貫した適用
  3. **T4.3**: グローバル変数依存の除去
     - 対象: global.*_appgenius_* 変数の使用箇所
     - 実装: 明示的なサービス参照に置き換え
- **検証ポイント**:
  - サービス間の通信が正常に機能すること
  - グローバル変数への参照がないこと
  - コンポーネント間の依存関係が明示的になっていること

### フェーズ5: UI コンポーネントの整理
- **目標**: UI コンポーネントの責任分離と再利用性向上
- **影響範囲**: src/ui/ ディレクトリ
- **タスク**:
  1. **T5.1**: 共通 UI コンポーネントの抽出
     - 対象: 複数の UI コンポーネントで共通するコード
     - 実装: 共通機能を src/ui/common/ に抽出
  2. **T5.2**: UI コンポーネント状態管理の改善
     - 対象: 各 UI コンポーネントの状態管理
     - 実装: コンポーネント内状態と外部状態の明確な分離
  3. **T5.3**: WebView 通信の標準化
     - 対象: WebView メッセージ処理
     - 実装: 一貫したメッセージング規約の適用
- **検証ポイント**:
  - UI コンポーネントが正常に表示・動作すること
  - コンポーネント間で一貫したスタイルと動作が維持されること
  - WebView 通信が安定して動作すること

## 5. 期待される効果

### 5.1 コード削減
- バックアップファイルの削除: 約 3,000 行
- プロンプトライブラリ関連ファイルの削除: 約 1,500 行
- 未使用クラスと関連ファイルの削除: 約 2,000 行
  - GitManager: 約 300 行
  - mockupGenerator: 約 400 行
  - CodeGenerator, TestGenerator, CodeEditor: 約 1,300 行
- その他未使用コードの削除: 約 1,000 行
- 重複コードの統合: 約 1,500 行
- 全体で約 9,000 行（30%以上）のコード削減

### 5.2 保守性向上
- 明確に定義された責任分離による変更の影響範囲の限定
- 一貫したコーディングパターンと命名規則の適用
- 依存関係の明示化によるコード理解の容易化
- テスト可能性の向上

### 5.3 拡張性改善
- 新機能追加時の明確な配置場所
- プラグイン式アーキテクチャによる機能拡張の容易化
- イベント駆動設計による疎結合の実現
- インターフェース指向設計による実装詳細の隠蔽

## 6. リスクと対策

### 6.1 潜在的リスク
- **機能停止**: 依存関係の見落としによる機能停止
- **認証問題**: 認証システムの変更による既存ユーザーへの影響
- **バックエンド連携**: API クライアント変更によるバックエンド連携の問題
- **移行中の不安定性**: リファクタリング中のコードの不安定性

### 6.2 対策
- **段階的移行**: 各フェーズ後の完全なテストと検証
- **バックアップ**: リファクタリング前の完全なコードバックアップ
- **フィーチャーフラグ**: 新旧実装を切り替えられるフラグの導入
- **CI/CD 強化**: 自動テストの拡充と継続的な検証
- **ロールバック計画**: 問題発生時の迅速なロールバック手順の確立

## 7. 備考

### 7.1 未使用クラスの詳細分析

調査の結果、以下のクラスが未使用または部分的に使用されていることが確認されました：

1. **GitManager** (src/core/gitManager.ts)
   - 完全に未使用
   - extension.tsでインポートはされているが、インスタンス化されていない
   - 安全に削除可能

2. **mockupGenerator** (src/modes/requirementMode/mockupGenerator.ts)
   - 完全に未使用
   - どのファイルからも参照されていない
   - 同様の機能がAIServiceで既に実装されている
   - 安全に削除可能

3. **ProjectAnalyzer** (src/core/projectAnalyzer.ts)
   - 直接的には使用されていない
   - extension.tsでインポートされているが使用されていない
   - CodeGenerator、TestGenerator、CodeEditorで参照されているが、これらのクラス自体も未使用
   - 安全に削除可能

4. **CodeGenerator, TestGenerator, CodeEditor**
   - 実装はされているが実際にはどこでも使用されていない
   - CodeGeneratorはextension.tsでインポートされているが使用されていない
   - これらは開発支援機能として実装されたが、実際には使用されていない
   - 安全に削除可能

### 7.2 実装アプローチ

このリファクタリング計画は、現在進行中の media フォルダリファクタリングと連携して実施すると効果的です。また、同時に TypeScript の strict モード有効化も検討し、型安全性の向上も図ることを推奨します。

リファクタリング作業は各フェーズごとに独立したブランチで実施し、各フェーズ完了時に main ブランチにマージするアプローチを推奨します。これにより、リファクタリングの進捗管理と問題発生時の対応が容易になります。

特に未使用クラスの削除については、一括で行うのではなく、小さな単位で変更をコミットし、各ステップでテストを実施することで安全に進めることができます。