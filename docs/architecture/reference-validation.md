# ドキュメント参照の検証ガイドライン

## 1. 概要

本ドキュメントは、AppGeniusプロジェクトにおけるドキュメント間参照の整合性を確保するための検証ルールとプロセスを定義します。ドキュメント間の参照が正確かつ最新であることを保証するための具体的な方法を提供します。

## 2. 参照検証の重要性

正確で信頼性の高いドキュメント参照システムは以下の価値をもたらします：

- **一貫性**: すべてのドキュメントが最新かつ同期された情報を参照
- **追跡可能性**: 情報の出所と変更履歴を明確に追跡可能
- **効率性**: AIエージェントと開発者が必要な情報に迅速にアクセス可能
- **品質保証**: 情報の正確性と網羅性を確保

## 3. 参照リンクの検証ルール

### 3.1 パス検証ルール

すべてのドキュメント参照パスは以下の条件を満たす必要があります：

1. **絶対パスの使用**: すべての参照は絶対パス（`/docs/...`）で記述
2. **既存ファイル**: 参照先のファイルが実際に存在すること
3. **拡張子の一貫性**: 適切なファイル拡張子（`.md`、`.html`等）を使用
4. **大文字小文字の一致**: ファイル名の大文字小文字が実際のファイルシステムと一致

**パス検証の例**:
```
正: [要件定義](/docs/requirements.md)
誤: [要件定義](../requirements.md)
誤: [要件定義](/docs/Requirements.md) ← 大文字小文字が不一致
誤: [要件定義](/docs/requirements) ← 拡張子がない
```

### 3.2 アンカー検証ルール

セクション参照のアンカーリンクは以下の条件を満たす必要があります：

1. **アンカー存在**: 参照先ドキュメント内に該当するアンカーが存在
2. **アンカー形式**: アンカーIDは標準化された形式に準拠
3. **アンカー一貫性**: 同じセクションへの参照は常に同じアンカーIDを使用

**アンカー検証の例**:
```
正: [認証機能](/docs/requirements.md#2-3-認証機能)
誤: [認証機能](/docs/requirements.md#認証) ← 標準形式でない
誤: [認証機能](/docs/requirements.md#auth) ← 標準形式でない
誤: [認証機能](/docs/requirements.md#2-4-認証機能) ← 誤ったセクション番号
```

### 3.3 双方向参照検証ルール

関連ドキュメント間の相互参照は以下の条件を満たす必要があります：

1. **相互参照の存在**: AがBを参照する場合、BもAを参照すること
2. **参照の一貫性**: 相互参照の記述が矛盾しないこと
3. **参照セクションの標準化**: 標準的な「関連ドキュメント」セクションで参照すること

**双方向参照の例**:
```
# requirements.md内
[現在の実装状況](/docs/CURRENT_STATUS.md)

# CURRENT_STATUS.md内
[要件定義](/docs/requirements.md#2-3-認証機能)
```

## 4. 参照検証のプロセス

### 4.1 自動検証プロセス

ドキュメント参照の自動検証は以下のタイミングで実施します：

1. **コミット前検証**: ドキュメント変更をコミットする前に参照の整合性を検証
2. **定期検証**: 週次での自動参照検証ジョブの実行
3. **大規模変更後**: ドキュメント構造に大きな変更があった後の総合検証

### 4.2 検証ツールと方法

参照検証には以下のツールとアプローチを利用します：

1. **Markdownリンクチェッカー**: 全Markdownファイル内のリンク検証
2. **カスタム検証スクリプト**: プロジェクト固有のルールに基づく参照検証
3. **参照グラフ生成**: ドキュメント間の参照関係を視覚化し分析

**検証スクリプトの例**:
```javascript
// リンク検証スクリプト例
function validateDocumentReferences() {
  // ドキュメントをスキャン
  const allDocs = scanAllDocuments();
  
  // リンク抽出と検証
  allDocs.forEach(doc => {
    const links = extractLinks(doc);
    links.forEach(link => {
      validateLink(link, allDocs);
    });
  });
  
  // 双方向参照の検証
  validateBidirectionalReferences(allDocs);
  
  // レポート生成
  generateValidationReport();
}
```

### 4.3 検証レポート

参照検証の結果は以下の形式でレポートします：

1. **エラーリスト**: 壊れた参照、不正確な参照のリスト
2. **警告リスト**: 潜在的な問題のある参照パターン
3. **改善提案**: 参照構造の最適化提案
4. **検証統計**: 検証済み参照数、成功率、問題カテゴリの分布

**レポート例**:
```
# ドキュメント参照検証レポート - 2025-05-09

## サマリー
- 検証済み参照数: 237
- 有効な参照: 228 (96.2%)
- エラー: 6 (2.5%)
- 警告: 3 (1.3%)

## エラー
1. [/docs/api/users.md#delete-user] - 参照先セクションが存在しません
2. [/docs/deployment/staging.md] - 参照先ファイルが存在しません
...

## 警告
1. [/docs/requirements.md] - 双方向参照が不完全です (architecture/data-model.md)
...

## 改善提案
- "API仕様書"への参照形式を標準化してください
...
```

## 5. 参照整合性の維持ガイドライン

### 5.1 ドキュメント変更時のガイドライン

ドキュメントを変更する際に従うべきルール：

1. **ファイル移動**: ファイルを移動・名前変更する場合は、そのファイルへの参照をすべて更新
2. **セクション変更**: セクション見出しを変更する場合は、そのセクションへの参照をすべて更新
3. **構造変更**: ドキュメント構造を変更する場合は、参照マップを更新し影響範囲を確認
4. **一時的不整合**: 大規模変更時は一時的な不整合を許容するが、変更完了後に検証を実施
5. **型定義の更新**: `shared/index.ts`の型定義を変更する場合は変更履歴をコメントに記録し、関連するAPIドキュメントも更新

### 5.2 新規ドキュメント作成時のガイドライン

新しいドキュメントを作成する際に従うべきルール：

1. **標準テンプレート**: 参照セクションを含む標準テンプレートの使用
2. **関連ドキュメント特定**: 関連するすべての既存ドキュメントを特定
3. **双方向参照**: 関連ドキュメントへの参照と、それらのドキュメントからの逆参照を作成
4. **参照マップ更新**: 必要に応じて参照マップを更新

**新規ドキュメントテンプレート例**:
```markdown
# [ドキュメントタイトル]

## メタデータ
- **バージョン**: 1.0.0
- **作成日**: 2025-05-XX
- **最終更新**: 2025-05-XX
- **ステータス**: ドラフト|レビュー中|承認済み

## 関連ドキュメント
- **要件**: [関連要件](/docs/requirements.md#section)
- **API仕様**: [関連API](/docs/api/feature.md)
- **モックアップ**: [関連UI](/mockups/pages/feature.html)

## 1. 概要

...
```

### 5.3 ドキュメントアーカイブと履歴管理

古いバージョンのドキュメントを参照する場合のルール：

1. **バージョン明示**: 特定バージョンへの参照時はバージョン番号を明示
2. **アーカイブパス**: 古いバージョンは `archived/` ディレクトリに移動し、その旨を明記
3. **最新版リンク**: アーカイブドキュメントからは必ず最新版へのリンクを提供

**アーカイブ参照例**:
```markdown
## 参考資料
- [認証仕様書 v1.2.3](/docs/archived/auth-v1.2.3.md) (2025-04-10)
- [最新の認証仕様書](/docs/api/auth.md)
```

## 6. エージェント向け参照検証ガイド

AIエージェントが参照の整合性を維持するためのガイドライン：

### 6.1 参照生成時のチェックリスト

AIエージェントがドキュメント参照を生成する際のチェックリスト：

1. ✅ 絶対パスを使用しているか
2. ✅ ファイル名と拡張子が正確か
3. ✅ セクション参照の場合、正確なアンカーIDを使用しているか
4. ✅ 公式の参照形式に従っているか
5. ✅ 逆参照が必要な場合、それも作成・更新しているか

### 6.2 エージェント間参照引き継ぎプロトコル

エージェント間で作業を引き継ぐ際の参照プロトコル：

1. **作成ドキュメントリスト**: 作成・更新したドキュメントのリスト
2. **新規参照リスト**: 新たに追加した参照のリスト
3. **参照更新リスト**: 更新した参照のリスト
4. **検証ステータス**: 参照検証の結果

**引き継ぎ例**:
```markdown
## エージェント作業報告

### 作成・更新ドキュメント
- [API仕様書](/docs/api/users.md) - 新規作成
- [データモデル](/docs/architecture/data-model.md) - ユーザーエンティティを更新

### 参照更新
- requirements.md → data-model.md の参照を追加
- data-model.md → api/users.md の参照を追加

### 参照検証
✅ すべての新規・更新参照を検証済み
```

## 7. 参照パターンの実践例

### 7.1 データモデル参照パターン

データモデルに関する参照は、説明とソースコード型定義の両方を提供します：

```markdown
## ユーザーモデル

- **モデル概要**: [ユーザーエンティティ説明](/docs/architecture/data-model.md#user-entity)
- **型定義**: [IUser, SafeUser型定義](/shared/index.ts#L366-L434)

ユーザーモデルは認証システムの基盤として、アプリケーション全体でのユーザー識別と権限管理を担当します。
```

### 7.2 API仕様書の参照パターン

API仕様書は型定義の正確な行番号を参照し、ドキュメントと実装の整合性を確保します：

```markdown
## POST /api/users

**リクエスト型**: [CreateUserDTO](/shared/index.ts#L412-L419)
**レスポンス型**: [ApiResponse<SafeUser>](/shared/index.ts#L219)

このエンドポイントは新規ユーザーを作成し、パスワードを除いたユーザー情報を返します。
```

### 7.3 コード内の参照コメント

実装コードでは型定義とドキュメントへの参照をコメントで示します：

```typescript
/**
 * ユーザー認証サービス
 * @see /shared/index.ts#L366-L434 - ユーザー型定義
 * @see /docs/api/auth.md - 認証API仕様
 */
class AuthService {
  // 実装
}
```

### 7.4 コンテキストに応じた参照テキスト

参照のコンテキストに応じて適切な説明テキストを提供します：

```markdown
詳細については[ユーザー認証フロー](/docs/architecture/auth-flow.md)を参照してください。

この問題は[認証時のエラーハンドリング](/docs/architecture/auth-flow.md#error-handling)で解決されています。
```

### 7.5 参照カテゴリタグ

重要な参照には目的や性質を示すカテゴリタグを付けます：

```markdown
- **[必読]** [アーキテクチャ原則](/docs/architecture/principles.md)
- **[詳細情報]** [認証プロトコル仕様](/docs/architecture/auth-protocols.md)
- **[例]** [サンプル実装](/docs/examples/auth-example.md)
- **[型定義]** [APIレスポンス型](/shared/index.ts#L187-L244)
```

## 8. 参照品質メトリクス

ドキュメント参照の品質を測定するメトリクス：

1. **参照有効率**: 有効な参照の総参照数に対する割合
2. **双方向参照完全性**: 適切に双方向参照されているドキュメントの割合
3. **参照密度**: ドキュメントあたりの平均参照数
4. **孤立ドキュメント**: 他のドキュメントから参照されていないドキュメントの数
5. **中心性スコア**: 他のドキュメントからの参照が多いコアドキュメントの特定

## 9. まとめ

ドキュメント参照の検証と整合性維持は、効果的な開発プロセスの基盤です。本ドキュメントで定義された検証ルールとプロセスに従うことで、AppGeniusプロジェクトのドキュメント間の参照品質を高く保ち、AIエージェントと開発者の効率を最大化します。