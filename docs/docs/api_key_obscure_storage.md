# APIキー隠蔽ストレージシステム 技術仕様書

**バージョン**: 1.0  
**作成日**: 2025-07-01  
**作成者**: BlueLamp開発チーム  
**機密度**: 内部限定

## 概要

BlueLamp CLIのAPIキー保存システムは、従来の明確な場所（`~/.config/bluelamp/auth.json`）から、セッションログに偽装した場所へ移行しました。これにより、攻撃者がAPIキーを発見することを極めて困難にしています。

本ドキュメントは、システムの技術的詳細と実装方法を記載した内部向け資料です。

## アーキテクチャ

### 1. 保存場所の偽装

**従来の保存場所:**
```
~/.config/bluelamp/auth.json  # 明らかに認証情報とわかる
```

**新しい保存場所:**
```
~/.openhands/sessions/2874fd16-7e86-4c34-98ac-d2cfb3f62478-d5e2b751df612560/events/1.json
```

この場所は、通常のセッションログと完全に同じ構造を持ち、攻撃者には区別がつきません。

### 2. ファイル構造

```
~/.openhands/sessions/
├── 本物のセッション1/
├── 本物のセッション2/
├── 2874fd16-7e86-4c34-98ac-d2cfb3f62478-d5e2b751df612560/  # 固定の偽セッション
│   ├── events/
│   │   ├── 1.json     # APIキー（暗号化済み）
│   │   ├── 2.json     # ダミーイベント
│   │   ├── 3.json     # ダミーイベント
│   │   └── ...
│   └── event_cache/
│       └── 0-25.json  # ダミーキャッシュ
└── デコイセッション×20個
```

### 3. セキュリティ層

#### 3.1 暗号化
- APIキーは必ず暗号化されて保存
- セッション固有の暗号化キーを使用
- メモリ暗号化システム（`memory_encryption.py`）を活用

#### 3.2 偽装
- セッションID形式: `UUID-ランダム16進数`
- イベントファイル形式: 本物のイベントと同じJSON構造
- タイムスタンプ、action、source等も本物と同じ

#### 3.3 難読化
- 固定セッションID使用（動的生成による脆弱性を回避）
- コメントなし（攻撃者へのヒントを排除）
- フォールバックなし（単一の動作パスのみ）

## 実装詳細

### ObscureStorage クラス

```python
class ObscureStorage:
    FAKE_SESSION_ID = "2874fd16-7e86-4c34-98ac-d2cfb3f62478-d5e2b751df612560"
    API_KEY_FILE_POSITION = 1  # 常に1.jsonに保存
```

**主要メソッド:**

1. `save_api_key(api_key: str) -> bool`
   - APIキーを暗号化
   - 1.jsonとして保存
   - 初回のみダミーファイル作成

2. `load_api_key() -> Optional[str]`
   - 固定パスから読み込み
   - 復号化して返却

3. `clear_api_key() -> bool`
   - 1.jsonのみ削除（ダミーは残す）

4. `create_decoy_sessions(count: int)`
   - デコイセッションを大量生成
   - 本物と見分けがつかない構造

### 統合ポイント

1. **PortalAuthenticator** (`openhands/cli/auth.py`)
   - `save_api_key()`: 新システムに保存
   - `load_api_key()`: 新システムから読み込み
   - フォールバックなし

2. **PortalPromptClient** (`openhands/portal/prompt_client.py`)
   - `_load_api_key()`: 新システムから読み込み

3. **PortalIntegration** (`portal_integration.py`)
   - スタンドアロン対応（ImportError処理）

## セキュリティ分析

### 攻撃シナリオと防御

1. **ファイルシステムスキャン**
   - 300以上のセッションディレクトリから探す必要
   - `auth.json`のような明確な名前なし

2. **メモリダンプ攻撃**
   - APIキーは常に暗号化状態
   - 復号化は使用時の一瞬のみ

3. **リバースエンジニアリング**
   - 固定セッションIDはハードコード
   - しかし数百のセッションから特定は困難

4. **ソーシャルエンジニアリング**
   - コメントなし
   - 変数名も一般的

### 残存リスク

1. **固定セッションIDの露出**
   - ソースコードを見れば判明
   - 対策: コンパイル時の難読化

2. **1.jsonという固定位置**
   - パターンが判明すれば狙われる
   - 対策: 将来的にランダム化も検討

## 移行プロセス

### 自動移行
注意: 現在の実装では、新規インストール時のみ新システムを使用します。既存の`auth.json`からの自動移行は実装されていません。

### 手動確認方法

```bash
# APIキーの保存場所を確認
ls -la ~/.openhands/sessions/2874fd16-7e86-4c34-98ac-d2cfb3f62478-d5e2b751df612560/events/1.json

# 内容確認（暗号化されているはず）
cat ~/.openhands/sessions/2874fd16-7e86-4c34-98ac-d2cfb3f62478-d5e2b751df612560/events/1.json | jq .data

# 旧ファイルが削除されていることを確認
ls -la ~/.config/bluelamp/auth.json  # 存在しないはず
```

## トラブルシューティング

### 問題: ログインできない
1. 固定セッションディレクトリの権限確認
2. `~/.openhands/sessions/`の存在確認

### 問題: APIキーが見つからない
1. 正しいパスを確認: `2874fd16-7e86-4c34-98ac-d2cfb3f62478-d5e2b751df612560`
2. 1.jsonの存在確認

### デバッグモード
```python
# ログレベルをDEBUGに設定
import logging
logging.getLogger('bluelamp').setLevel(logging.DEBUG)
```

## 将来の改善案

1. **動的な保存位置**
   - 1.jsonではなく、2-10の間でランダム
   - セッションIDも一定期間で変更

2. **多層暗号化**
   - 現在: 単一暗号化
   - 将来: 分散暗号化（Shamir's Secret Sharing）

3. **ハニーポット**
   - 偽のauth.jsonを配置
   - アクセスしたら警告

4. **定期的な再暗号化**
   - 暗号化キーの定期更新
   - 保存場所の定期移動

## 実装の詳細コメント

### なぜ固定セッションIDなのか？

動的にセッションIDを生成する方式も検討しましたが、以下の理由で固定方式を採用：

1. **堅牢性**: 保存場所の履歴管理が不要で、実装の脆弱性が入り込む余地が少ない
2. **シンプルさ**: ランダム生成ロジックのバグによる予測可能性のリスクがない
3. **メモリ効率**: 保存場所を記憶する追加情報が不要

### コメントを最小限にした理由

ソースコード内のコメントは攻撃者にとって貴重な情報源となります。そのため：
- クラスやメソッドのdocstringを削除
- 処理の意図を説明するコメントを削除
- 変数名も一般的なものを使用

### フォールバックを削除した理由

後方互換性のためのフォールバック機能は、セキュリティホールになる可能性があります：
- 攻撃者は最も脆弱な経路を探す
- 複数の保存場所は攻撃対象を増やす
- 単一の動作パスの方が監査しやすい

## パフォーマンスへの影響

### 暗号化/復号化のオーバーヘッド
- Fernet暗号化: 約0.1ms（典型的なAPIキーサイズ）
- ファイルI/O: 約1-2ms
- 合計: 約2-3ms（初回読み込み時のみ）

### メモリ使用量
- 暗号化により約30%増加（Base64エンコーディング）
- APIキー1つあたり約200バイト → 260バイト

## セキュリティ監査チェックリスト

- [ ] 固定セッションIDがソースコードに含まれていることを理解
- [ ] デコイセッションが20個生成されることを確認
- [ ] APIキーが平文で保存されていないことを確認
- [ ] 旧auth.jsonが存在しないことを確認
- [ ] ファイルパーミッションが600であることを確認

## まとめ

このシステムは「Security through Obscurity」と「暗号化」を組み合わせた多層防御を実現しています。攻撃者にとって：

1. **発見が困難**: 数百のセッションから特定不可能
2. **解読が困難**: 暗号化されている
3. **パターン分析が困難**: 本物のセッションと同じ構造

これにより、CLIツールとしては非常に高いセキュリティレベルを達成しています。

## 更新履歴

- 2025-07-01 v1.0: 初版作成
  - APIキー隠蔽ストレージシステム実装
  - メモリ暗号化統合
  - デコイセッション生成機能