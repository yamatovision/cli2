# ScopeManagerPanel 段階的リファクタリング実装計画 - 改善版

## 1. 概要

このドキュメントは、大規模な`media/scopeManager.js`ファイルの保守性と拡張性を向上させるための段階的リファクタリング計画です。「骨を残して肉を入れ替える」アプローチと依存関係マッピングに基づき、相互依存性の低い機能から優先的に分離を進めます。

## 2. 目標

1. 単一責任の原則に従った関数・モジュールの整理
2. 常に動作する状態を維持する段階的リファクタリング
3. 相互依存が強い機能を安全に扱う方法の確立
4. 将来の機能拡張をしやすくする設計の実現

## 3. 依存関係マッピングと機能分離の優先順位

### 3.1 機能ごとの独立性スコア（10点満点）

| 機能カテゴリ | 独立性スコア | 相互依存の状況 | 分離優先度 |
|-------------|------------|--------------|----------|
| マークダウン変換 | 9/10 | ほぼ独立した純粋関数 | 最優先 ✅ |
| UIヘルパー関数 | 8/10 | 一部UI状態に依存 | 高 ✅ |
| タブ管理 | 7/10 | 状態管理に一部依存 | 高 |
| ダイアログ表示 | 6/10 | 状態や他UIに軽度依存 | 中高 |
| マークダウンビューア | 5/10 | マークダウン変換と状態に依存 | 中 |
| プロジェクト管理 | 4/10 | 多くの機能と連携 | 中低 |
| メッセージハンドラ | 2/10 | 多くの機能と強く相互依存 | 低 |
| 状態管理 | 1/10 | ほぼすべての機能と相互依存 | 最低 |

### 3.2 分離検討時の判断基準

- **独立性スコア 7以上**: 安全に分離可能
- **独立性スコア 4-6**: 段階的に慎重に分離
- **独立性スコア 1-3**: 直接分離を避け、ファサードやメディエーターパターンを検討

## 4. リファクタリングの改善アプローチ

### 4.1 「骨を残して肉を入れ替える」改良アプローチ

1. **独立性の高い機能から着手**: 他機能への依存が少ない機能から分離を開始
2. **並行運用の徹底**: 移行中も元のコードを維持し、新実装と比較検証
3. **ユーザーフィードバックの組み込み**: 各ステップでの確認を必須化
4. **一方向の依存関係**: 循環依存を避け、明確な階層構造を持つ設計

### 4.2 相互依存への対処方法

1. **ファサードパターン**: 複雑な依存関係をシンプルなインターフェースで隠蔽
2. **メディエーターパターン**: コンポーネント間の直接依存を避け、仲介役を導入
3. **イベント駆動アーキテクチャ**: 直接的な依存関係をイベントリスナーに変換
4. **ブランチバイテスト**: 条件フラグによる新旧実装の切り替え機能の導入

## 5. ディレクトリ構造

```
media/
├── scopeManager.js → 段階的に縮小していくメインファイル
├── components/
│   ├── markdownViewer/
│   │   ├── markdownViewer.js  → マークダウン表示関連機能
│   │   └── markdownViewer.css
│   ├── tabManager/
│   │   ├── tabManager.js      → タブ切替関連機能
│   │   └── tabManager.css
│   ├── projectNavigation/
│   │   ├── projectNavigation.js → プロジェクト管理関連機能
│   │   └── projectNavigation.css
│   ├── dialogManager/
│   │   ├── dialogManager.js   → ダイアログと通知関連機能
│   │   └── dialogManager.css
│   └── sharingPanel.js (既存)
├── state/
│   └── stateManager.js        → 状態管理関連機能
└── utils/
    ├── markdownConverter.js   → マークダウン変換関連機能
    ├── messageHandler.js      → メッセージ処理関連機能
    └── uiHelpers.js           → UI操作のヘルパー関数
```

## 6. 具体的な実装ステップ

### フェーズ1: 準備と依存関係分析

- [x] **タスク1.1: 依存関係マッピング**
  - 機能間の相互依存関係を可視化
  - 独立性スコアによる分離優先度の決定

- [x] **タスク1.2: バックアップと環境準備**
  - 現状のscopeManager.jsをバックアップ
  - 新しいディレクトリ構造の作成

- [x] **タスク1.3: モジュール化テンプレート準備**
  - ESモジュールの構造設計
  - インポート/エクスポート方式の標準化

### フェーズ2: マークダウン変換機能の分離 (独立性スコア: 9/10)

- [x] **タスク2.1: マークダウン変換関数の特定**
  - `convertMarkdownToHtml()` など純粋関数を特定
  - 関連する補助関数の依存関係分析

- [x] **タスク2.2: markdownConverter.js の作成**
  - 純粋関数としての再実装
  - 明確なインターフェース設計

- [x] **タスク2.3: 元コードと並行動作の実装**
  - 新旧実装の結果比較機能の追加
  - 不一致時に警告するセーフガード実装

- [x] **タスク2.4: 動作検証とユーザー確認**
  - 様々なマークダウン入力での結果確認
  - 実際のユースケースでの機能検証

#### フェーズ2の実装完了サマリー
- ScopeManagerPanel.tsにスクリプトタグの`type="module"`属性を追加し、ES Modulesのインポート機能を有効化
- マークダウン変換関連のすべての関数を`markdownConverter.js`に移動
- `scopeManager.js`で`import { convertMarkdownToHtml, enhanceSpecialElements, setupCheckboxes } from './utils/markdownConverter.js';`を追加
- すべてのエッジケースでも問題なく動作することを確認

### フェーズ3: UIヘルパー関数の分離 (独立性スコア: 8/10)

- [x] **タスク3.1: UIヘルパー関数の特定**
  - DOM操作やスタイル処理など独立した関数を特定
  - 他機能への依存が少ない関数を優先

- [x] **タスク3.2: uiHelpers.js モジュールの作成**
  - 純粋関数として実装可能な操作を抽出
  - 汎用的かつ再利用可能なインターフェース設計

- [x] **タスク3.3: 段階的移行と並行検証**
  - 新旧実装の並行動作による比較検証
  - エッジケースへの対応確認

- [x] **タスク3.4: 完全移行とクリーンアップ**
  - 元のコード内の冗長な実装を削除
  - インポート方式への完全移行

### フェーズ4: タブ管理機能の分離 (独立性スコア: 7/10)

- [ ] **タスク4.1: タブ管理関連コードの特定**
  - タブ切替の初期化、選択、表示に関する機能を特定
  - 状態管理との依存部分を明確化

- [ ] **タスク4.2: tabManager.js の実装**
  - タブ機能のカプセル化
  - 他機能への依存を最小限に抑えたインターフェース設計

- [ ] **タスク4.3: 新旧実装の並行動作と比較**
  - 条件分岐による新旧実装の切り替え機能
  - エラー発生時に自動的に元の実装へ復帰する機能

- [ ] **タスク4.4: ユーザー確認と問題修正**
  - 実際のタブ操作フローでの徹底検証
  - 問題点の特定と修正

### フェーズ5: ダイアログ管理の分離 (独立性スコア: 6/10)

- [ ] **タスク5.1: ダイアログ関連機能の特定**
  - エラー表示、確認、通知に関わる機能を特定
  - UI状態との依存関係の分析

- [ ] **タスク5.2: dialogManager.js の実装**
  - 通知とダイアログのカプセル化
  - 拡張しやすいインターフェース設計

- [ ] **タスク5.3: 新旧実装の並行運用**
  - 複数のダイアログパターンでの比較検証
  - エッジケースの洗い出しと対応

- [ ] **タスク5.4: ユーザー確認と問題修正**
  - 実際の操作フローでの検証
  - 問題発見時の即時対応

### フェーズ6: マークダウンビューアの分離 (独立性スコア: 5/10)

- [ ] **タスク6.1: マークダウン表示機能の特定**
  - 表示処理と対話機能（チェックボックスなど）を特定
  - マークダウン変換機能との依存関係を整理

- [ ] **タスク6.2: markdownViewer.js の実装**
  - 表示と対話機能のカプセル化
  - 他コンポーネントとの連携インターフェース設計

- [ ] **タスク6.3: 段階的移行と検証**
  - 様々なマークダウンコンテンツでの表示テスト
  - インタラクション機能の検証

- [ ] **タスク6.4: ユーザー確認と調整**
  - 実際の操作フローでのフィードバック収集
  - 問題発見時の修正対応

### フェーズ7: プロジェクト管理機能の分離 (独立性スコア: 4/10)

- [ ] **タスク7.1: プロジェクト関連機能の特定と分析**
  - プロジェクト選択、表示、管理機能の特定
  - 複数機能との依存関係の整理

- [ ] **タスク7.2: projectNavigation.js の実装**
  - ファサードパターンによるシンプルなインターフェース設計
  - 内部実装の詳細を隠蔽

- [ ] **タスク7.3: 段階的移行計画**
  - 小規模の変更から開始し、徐々に拡大
  - 各ステップでの検証を徹底

- [ ] **タスク7.4: ユーザー確認と調整**
  - プロジェクト管理の全操作フローでの検証
  - フィードバックに基づく修正

### フェーズ8: 相互依存の強い機能への対処

- [ ] **タスク8.1: メッセージハンドラへの対処 (独立性スコア: 2/10)**
  - ファサードパターンによるシンプルな中継インターフェース設計
  - 段階的かつ小規模な変更と検証の繰り返し

- [ ] **タスク8.2: 状態管理への対処 (独立性スコア: 1/10)**
  - 状態読み取り専用インターフェースの導入
  - 変更通知メカニズムの段階的実装

- [ ] **タスク8.3: 統合テストと検証**
  - 全機能の連携動作確認
  - パフォーマンスと安定性の評価

## 7. 安全性確保の具体策

### 7.1 並行稼働のための実装パターン

```javascript
// 新旧実装の比較検証パターン例
function someFunction(params) {
  // 元の実装
  const originalResult = originalImplementation(params);
  
  // 新実装（条件フラグで切り替え可能）
  let newResult;
  try {
    if (USE_NEW_IMPLEMENTATION) {
      newResult = newImplementation(params);
      
      // 比較検証（開発中のみ）
      if (JSON.stringify(newResult) !== JSON.stringify(originalResult)) {
        console.warn('New implementation returned different result!', {
          original: originalResult,
          new: newResult,
          params
        });
      }
    }
  } catch (error) {
    console.error('Error in new implementation:', error);
    // エラー時は元の実装結果を使用
  }
  
  return USE_NEW_IMPLEMENTATION && !error ? newResult : originalResult;
}
```

### 7.2 段階的移行のためのロールバック手順

1. 問題発見時に即時に元の実装に戻せるようフラグ管理
2. 各変更のコミット単位を小さく保ち、Git履歴から戻せるようにする
3. 変更前後の状態をスナップショットとして保存

### 7.3 ユーザー確認フェーズの具体的内容

1. 変更された機能の正常動作確認
2. エッジケースでの挙動検証
3. パフォーマンスへの影響評価
4. 他機能との連携確認

## 8. 進捗状況 (2025年5月3日更新)

### 完了フェーズ
- **フェーズ1** ✅: 依存関係分析と準備
- **フェーズ2** ✅: マークダウン変換機能の分離 (独立性スコア: 9/10)
- **フェーズ3** ✅: UIヘルパー関数の分離 (独立性スコア: 8/10)
  - showError, showSuccess, getStatusClass, getStatusText, getTimeAgo関数を移行
  - 不要なディレクトリ構造表示機能も整理済み

### 進行中フェーズ
- **フェーズ4** 🔄: タブ管理機能の分離 (独立性スコア: 7/10)
  - タブ関連機能の特定と分析を完了
  - tabManager.jsの基本構造設計中

### 次のステップ
1. **フェーズ4の続き** 🔜: タブ管理機能の完全分離
   - tabManager.jsの実装完了
   - 新旧実装の並行動作と比較検証
   - ユーザー確認と問題修正

2. **フェーズ5** 🔜: ダイアログ管理の分離 (独立性スコア: 6/10)
   - 独立性が比較的高いUI機能として次に着手

3. **長期計画**:
   - 独立性スコアの高い機能から順に分離を継続
   - 相互依存の強い機能は最後に対処

### 安全性向上に関する注記
- 各フェーズでの検証を徹底し、問題発見時は即時対応
- ユーザー確認ステップを各フェーズに必ず組み込む
- 複雑な依存関係を持つ機能は、直接的な分離よりも適切なパターン適用を優先