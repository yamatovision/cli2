#!/bin/bash

# BlueLamp CLI - Orchestrator Agent
# オーケストレーターがあなたのアプリの設計を統括します

# シンボリックリンクを解決して実際のディレクトリを取得
if [ -L "$0" ]; then
    # macOSでのreadlinkの制限に対応
    SCRIPT_PATH="$0"
    while [ -L "$SCRIPT_PATH" ]; do
        SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    done
else
    SCRIPT_PATH="$0"
fi
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

# 現在のディレクトリを保存（ユーザーが実行したディレクトリ）
CURRENT_DIR="$(pwd)"

# 環境変数を新しい形式に設定
export SANDBOX_VOLUMES="$CURRENT_DIR:/workspace:rw"

# 実行コマンドを識別するための環境変数
export BLUELAMP_COMMAND="bluelamp"

# Pythonパスを設定
export PYTHONPATH="$SCRIPT_DIR:$PYTHONPATH"

# セッション情報を表示
echo "🔵エージェント:オーケストレーター"
echo "ブルーランプを起動しています.."
echo ""

# プロジェクトディレクトリに一時的に移動してPoetryで実行
# pushd/popdを使って元のディレクトリを記憶
pushd "$SCRIPT_DIR" > /dev/null

# メインセッションを実行（新しいパス構造に対応）
# 実行後は自動的に元のディレクトリに戻る
poetry run python -m extensions.cli.main_session "$@"
EXIT_CODE=$?

# 元のディレクトリに戻る
popd > /dev/null

# 終了コードを返す
exit $EXIT_CODE