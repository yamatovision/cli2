# ScopeManagerPanel 分割リファクタリング実装計画 (UI検証重視版)

## 1. 概要

このドキュメントは、大規模な`media/scopeManager.js`ファイルを機能ごとに分割し、保守性と拡張性を向上させるための詳細な実装計画です。安全性を最優先とし、各ステップで動作確認と検証を行います。

## 2. 目標

1. 単一責任の原則に従ったモジュール構造への移行
2. UIの安定性を維持しながらコードの品質を向上
3. 段階的な実装と検証による既存機能の保全
4. 将来の機能拡張をしやすくする設計の実現

## 3. ディレクトリ構造

```
media/
├── scopeManager.js → エントリーポイント（最小化）
├── components/
│   ├── markdownViewer/
│   │   ├── markdownViewer.js
│   │   └── markdownViewer.css
│   ├── tabManager/
│   │   ├── tabManager.js
│   │   └── tabManager.css
│   ├── projectNavigation/
│   │   ├── projectNavigation.js
│   │   └── projectNavigation.css
│   ├── dialogManager/
│   │   ├── dialogManager.js
│   │   └── dialogManager.css
│   └── sharingPanel.js (既存)
├── state/
│   └── stateManager.js
└── utils/
    ├── markdownConverter.js
    ├── messageHandler.js
    └── uiHelpers.js
```

## 4. 安全なリファクタリングのための基本方針

1. **段階的移行**: 一度にすべてを変更せず、小さな変更を積み重ねる
2. **並行実行**: 新旧システムを一定期間併用し、結果を比較検証
3. **頻繁な検証**: 各モジュール実装後に動作確認を行う
4. **ロギング強化**: デバッグ情報を充実させ、問題の早期発見
5. **回帰防止**: 一つの機能移行ごとに全体のテストを実施

## 5. 実装手順と検証ポイント

### フェーズ0: 準備 (所要時間: 約1時間)

- [ ] **タスク0.1: 現状把握**
  - ScopeManagerPanel.tsとscopeManager.jsの全体構造を分析
  - 主要な機能とデータフローを特定

- [ ] **タスク0.2: 環境構築**
  - 新しいブランチを作成: `git checkout -b scope-manager-refactoring-safe`
  - 作業ディレクトリ構造の作成

- [ ] **タスク0.3: バックアップ**
  - 現状のscopeManager.jsをバックアップ: `media/scopeManager.js.bak`
  - VSCodeプロジェクト全体のスナップショットを作成

- [ ] **タスク0.4: 動作検証**
  - 現状の機能を確認するためのチェックリストを作成
  - スコープ変更、タブ切替、マークダウン表示など主要機能の動作確認

### フェーズ1: 状態管理モジュール (所要時間: 約3時間)

- [ ] **タスク1.1: StateManager基本構造実装**
  - `media/state/stateManager.js`を作成
  - VSCode状態APIとのインターフェース部分を実装
  - 基本的な状態取得・保存機能を実装

- [ ] **タスク1.2: 検証用フラグ追加**
  - デバッグモードとシャドウモードのフラグを追加
  - 状態変更ログ機能の追加

- [ ] **タスク1.3: UI状態なし検証**
  - VSCode状態APIとの連携をコンソールログで確認
  - **UI検証**: 現行動作に影響がないことを確認

- [ ] **タスク1.4: イベント通知システム実装**
  - 状態変更イベントリスナーの登録・削除機能を実装
  - 状態変更通知の実装

- [ ] **タスク1.5: テスト用ハーネス作成**
  - 状態変更を監視するデバッグコードを追加
  - コンソールにログを出力する仕組みを追加

- [ ] **タスク1.6: シャドウモード実装**
  - 既存の状態管理と新しいStateManagerを並行利用する機能を追加
  - 状態の差分を検出してログ出力する機能の実装

- [ ] **タスク1.7: 動作検証**
  - コンソールログで状態変更が正しく記録されているか確認
  - **UI検証**: 現行の動作に影響がないことを再確認

### フェーズ2: ユーティリティモジュール (所要時間: 約2時間)

- [ ] **タスク2.1: MarkdownConverter実装**
  - `media/utils/markdownConverter.js`を作成
  - マークダウン変換ロジックを抽出して実装
  - 表やコードブロックの特殊処理を実装

- [ ] **タスク2.2: UIHelpers実装**
  - `media/utils/uiHelpers.js`を作成
  - 共通のUI関数（ステータス表示、日付フォーマットなど）を実装

- [ ] **タスク2.3: 切り離し検証**
  - 既存コードでユーティリティモジュールのメソッドを使用
  - **UI検証**: マークダウン変換結果が既存と同じであることを確認

### フェーズ3: UI描画モジュール (所要時間: 約4時間)

- [ ] **タスク3.1: UIRenderer基本実装**
  - `media/utils/uiRenderer.js`を作成
  - DOM更新関数の基本構造を実装

- [ ] **タスク3.2: マークダウン表示機能の移行**
  - マークダウンHTML変換と表示ロジックの移行
  - MarkdownConverterとの連携実装

- [ ] **タスク3.3: タブ切替UI実装**
  - タブ切替ロジックの移行
  - 選択状態保持ロジックの実装

- [ ] **タスク3.4: スコープリスト表示実装**
  - スコープ一覧表示ロジックの移行
  - 選択状態の処理実装

- [ ] **タスク3.5: 動作検証**
  - シャドウモードで新旧レンダリング結果を比較
  - **UI検証**: マークダウン表示、タブ切替が正常に動作することを確認

### フェーズ4: イベント管理モジュール (所要時間: 約3時間)

- [ ] **タスク4.1: EventManager基本実装**
  - `media/utils/eventManager.js`を作成
  - イベントリスナー登録・管理の基本機能を実装

- [ ] **タスク4.2: ユーザーイベント処理の実装**
  - クリックイベント処理の移行
  - フォーム入力処理の移行
  - チェックボックス変更処理の移行

- [ ] **タスク4.3: イベントデリゲーション実装**
  - 親要素でのイベント受け取りと子要素への委譲処理実装

- [ ] **タスク4.4: クリーンアップ機能実装**
  - イベントリスナー解除の仕組みを実装
  - リソース解放処理の実装

- [ ] **タスク4.5: 動作検証**
  - すべてのユーザーイベントの動作を確認
  - **UI検証**: クリック、フォーム入力などすべての操作が正常に動作することを確認

### フェーズ5: メッセージング機能 (所要時間: 約3時間)

- [ ] **タスク5.1: MessageHandler基本実装**
  - `media/utils/messageHandler.js`を作成
  - VSCodeとのメッセージングインターフェース実装

- [ ] **タスク5.2: コマンドハンドラーの実装**
  - 各コマンドに対応するハンドラー関数を実装
  - StateManagerやUIRendererとの連携実装

- [ ] **タスク5.3: エラーハンドリング実装**
  - メッセージ処理中のエラー捕捉と回復機能の実装
  - エラー通知UIの実装

- [ ] **タスク5.4: 動作検証**
  - 各コマンドの送受信を確認
  - **UI検証**: 拡張機能との通信が正しく動作することを確認
  - エラー処理が正しく動作することを確認

### フェーズ6: UIコンポーネント分離 (所要時間: 約6時間)

- [ ] **タスク6.1: TabManager実装**
  - `media/components/tabManager/tabManager.js`を作成
  - タブ切替ロジックと状態管理を実装

- [ ] **タスク6.2: タブ動作検証**
  - タブ切替が正しく動作するか確認
  - **UI検証**: タブ状態の永続化が機能することを確認

- [ ] **タスク6.3: MarkdownViewer実装**
  - `media/components/markdownViewer/markdownViewer.js`を作成
  - マークダウン表示と特殊要素処理を実装

- [ ] **タスク6.4: マークダウン表示検証**
  - マークダウン表示が正しく動作するか確認
  - **UI検証**: 特殊フォーマット（表、コードブロック）が正しく表示されることを確認

- [ ] **タスク6.5: ProjectNavigation実装**
  - `media/components/projectNavigation/projectNavigation.js`を作成
  - プロジェクト一覧表示と選択処理を実装

- [ ] **タスク6.6: プロジェクトナビゲーション検証**
  - プロジェクト選択が正しく動作するか確認
  - **UI検証**: プロジェクト一覧と選択状態が正常に表示されることを確認

- [ ] **タスク6.7: DialogManager実装**
  - `media/components/dialogManager/dialogManager.js`を作成
  - ダイアログ表示と入力処理を実装

- [ ] **タスク6.8: ダイアログ動作検証**
  - モーダルダイアログが正しく動作するか確認
  - **UI検証**: ダイアログ表示とユーザー入力処理が正常に機能することを確認

### フェーズ7: エントリーポイント最小化 (所要時間: 約2時間)

- [ ] **タスク7.1: 新しいscopeManager.js作成**
  - モジュール読み込みとイベントリスナー設定のみを行う最小構造に
  - 各モジュールの初期化処理の実装

- [ ] **タスク7.2: プログレッシブ移行**
  - 既存コードと新コードを段階的に切り替える仕組みを実装
  - 問題発生時のフォールバック処理を実装

- [ ] **タスク7.3: 動作検証**
  - 全体の動作を確認
  - **UI検証**: すべての機能が正常に動作することを確認

### フェーズ8: 完全移行と最終検証 (所要時間: 約3時間)

- [ ] **タスク8.1: 古い参照の削除**
  - 既存コードの削除
  - 新しいモジュールへの完全移行

- [ ] **タスク8.2: 最終クリーンアップ**
  - 不要なデバッグコードの削除
  - コード整形と最終調整

- [ ] **タスク8.3: 総合検証**
  - すべての機能の動作を総合的に確認
  - 以下の観点での検証を実施:
    - タブ切替と状態保存
    - マークダウン表示と特殊要素処理
    - プロジェクト選択と表示
    - ダイアログ操作
    - エラー処理
    - パフォーマンス

- [ ] **タスク8.4: ユーザーテスト**
  - 複数のユーザーによる操作テスト
  - フィードバックに基づく微調整

- [ ] **タスク8.5: ドキュメント更新**
  - コードドキュメントの更新
  - リファクタリング計画書の更新

## 6. UI検証チェックリスト

各フェーズの「UI検証」ステップでは、以下の項目を確認してください：

### 基本機能

- [ ] **マークダウン表示**
  - CURRENT_STATUS.mdが正しく表示される
  - 見出し、リスト、コードブロックなどのフォーマットが正しく表示される
  - チェックボックスが操作可能で状態が保存される

- [ ] **タブ切り替え**
  - タブクリックでコンテンツが切り替わる
  - 切り替え後の状態が保持される
  - 他の画面から戻った際に前回のタブ状態が復元される

- [ ] **プロジェクトナビゲーション**
  - プロジェクト一覧が正しく表示される
  - プロジェクト選択が機能する
  - プロジェクト追加・削除が機能する
  - ナビゲーションの開閉が機能する

- [ ] **スコープ管理**
  - スコープ一覧が表示される
  - スコープ選択が機能する
  - スコープの詳細情報が表示される
  - 進捗バーが正しく表示される

### エラー処理

- [ ] **通信エラー処理**
  - ネットワークエラー時に適切なメッセージが表示される
  - 再試行が可能である

- [ ] **UI操作エラー処理**
  - 不正な操作時に適切なフィードバックがある
  - UIがクラッシュせず回復可能である

### 特殊ケース

- [ ] **大量データ処理**
  - 多数のスコープがある場合も正常に表示・操作できる
  - 大きなマークダウンファイルも正常に表示される

- [ ] **ページ遷移時の状態保持**
  - 他のビューに移動して戻った際に状態が保持されている
  - VSCode再起動後も状態が復元される

## 7. リスク対策

### リスク1: 状態管理による不整合

**対策:**
- シャドウモードで新旧の状態管理を並行実行し比較
- すべての状態変更時にログを出力し検証
- 重要な状態変更前後での一貫性チェック

### リスク2: イベント処理の欠落

**対策:**
- すべてのイベントハンドラを一覧化して移行漏れを防止
- イベント発火時のログ出力による確認
- 体系的なイベントテストの実施

### リスク3: UIレンダリングの不具合

**対策:**
- 部分的なレンダリング検証の実施
- HTML構造の比較によるレンダリング結果の検証
- スタイル適用後の見た目の検証

### リスク4: 循環参照や依存関係の問題

**対策:**
- 依存関係の明確な図式化と追跡
- 単方向データフローの原則の厳守
- モジュール初期化順序の慎重な設計

## 8. 成功指標

1. **機能的同等性**:
   - すべてのユーザー操作と結果が元のバージョンと同じであること

2. **コードの整理**:
   - 単一の大きなファイルが複数の小さなモジュールに分割されていること
   - 各モジュールが明確な責任を持つこと

3. **拡張性の向上**:
   - 新機能を既存コードの変更なしに追加できること
   - テスト容易性が向上していること

4. **パフォーマンスの維持/向上**:
   - ページ読み込み時間が既存のものと同等以上であること
   - 大量データ処理時のパフォーマンスが維持されていること

## 9. スケジュール

総所要時間: 約25時間（検証時間を含む）

- フェーズ0 (準備): 1時間
- フェーズ1 (状態管理): 3時間
- フェーズ2 (ユーティリティ): 2時間
- フェーズ3 (UI描画): 4時間
- フェーズ4 (イベント管理): 3時間
- フェーズ5 (メッセージング): 3時間
- フェーズ6 (UIコンポーネント): 6時間
- フェーズ7 (エントリーポイント): 2時間
- フェーズ8 (完全移行と検証): 3時間