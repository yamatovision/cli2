# プロジェクト切り替え機能の問題分析レポート

## 概要

AppGeniusアプリケーションのプロジェクト切り替え機能において、特定の状況下でプロジェクトが正しく切り替わらない問題が発生しています。本レポートでは、コードベースの詳細な分析を通じて特定された問題点と解決策を提案します。

## 問題の症状

プロジェクトを切り替えようとした際に、以下の症状が発生しています：

1. プロジェクト選択（selectProject）メッセージ処理が行われ、ログには「プロジェクト選択」の記録が残りますが、UI上で実際のプロジェクトが切り替わりません
2. モックアップギャラリーを開いた場合、UI状態と実際の表示されるプロジェクトに不一致が生じます
3. 複数の画面間を行き来すると、同じプロジェクト選択処理が繰り返され「同じプロジェクトが既に選択されています」というログが出力されます
4. 一部の画面では切り替えが正常に行われますが、他の画面では切り替えが反映されません

## アーキテクチャの分析

### 主要コンポーネント

AppGeniusのプロジェクト管理は以下の主要コンポーネントで構成されています：

1. **MessageDispatchServiceImpl**: WebViewとバックエンド間の通信を管理するサービス
2. **ProjectServiceImpl**: プロジェクト情報の管理と永続化を担当するサービス 
3. **stateManager.js**: フロントエンド（WebView）側で状態を管理するコンポーネント
4. **tabManager.js**: タブの状態管理と表示を担当するコンポーネント
5. **AppGeniusEventBus**: イベントベースの通信を提供するサービス

### データフロー

プロジェクト切り替え処理のデータフローは以下のようになっています：

```
UI操作 → stateManager.js → MessageDispatchServiceImpl → ProjectServiceImpl → 永続化
                                                       → イベント発行(AppGeniusEventBus)
                                                       → 他コンポーネントへの通知
```

## 特定された問題点

詳細な分析の結果、以下の問題点が特定されました：

### 1. プロジェクト状態の同期不全

最も重要な問題点は、プロジェクトの状態がアプリケーション内の異なるコンポーネント間で適切に同期されていないことです。

- **ProjectServiceImpl**はプロジェクト選択情報を正しく更新・保存していますが、他のコンポーネント（特にモックアップギャラリーなど）に変更が適切に伝播していません
- プロジェクト切り替え時のイベント伝播は`PROJECT_SELECTED`または`PROJECT_UPDATED`イベントを使用していますが、一部のコンポーネントでこれらのイベントが購読されていないか、適切に処理されていません

### 2. 単一責任の原則違反

- **MessageDispatchServiceImpl**は、メッセージングのみに集中すべきですが、プロジェクト選択ロジック（selectProject メソッド）の一部も実装しています
- 一部のロジックが複数の場所で重複して実装されており、整合性が取れなくなっています

### 3. 競合状態の問題

- `stateManager.js`内の`_isProcessingStateUpdate`フラグで状態更新の競合を防止しようとしていますが、非同期処理の完了を正しく待機していないため、状態の一貫性が保証されていません
- 重複した更新メッセージにより、前の更新が完了する前に次の更新が開始され、状態が不安定になる可能性があります

### 4. タブ状態管理の問題

- プロジェクト切り替え時に、`tabManager.js`で管理される画面のタブ状態が適切に更新されていません
- タブ状態の同期メカニズム（`saveTabState`メソッド）は実装されていますが、一部の状況下で呼び出されていません

### 5. モックアップギャラリー固有の問題

- `MockupGalleryPanel`クラスがプロジェクト変更イベントを正しく処理していません
- モックアップギャラリーパネルの更新に使用される`_updateProjectPath`メソッドがプロジェクト切り替え時に常に呼び出されるわけではありません

## 解決策の提案

### 1. 集中的な状態管理の実装

プロジェクト情報を一元的に管理し、すべてのコンポーネントが一貫した状態を参照できるようにします。

```typescript
// 状態管理を改善
class ProjectStateManager {
  private static _instance: ProjectStateManager;
  private _state: ProjectState;
  private _eventBus: AppGeniusEventBus;
  
  public static getInstance(): ProjectStateManager {
    if (!ProjectStateManager._instance) {
      ProjectStateManager._instance = new ProjectStateManager();
    }
    return ProjectStateManager._instance;
  }
  
  // プロジェクト更新時に全コンポーネントに通知するメソッド
  public updateActiveProject(project: IProjectInfo): void {
    this._state.activeProject = project;
    // 明示的なイベント発行
    this._eventBus.publish(
      AppGeniusEventType.PROJECT_UPDATED,
      { 
        project, 
        command: 'updateActiveProject',
        timestamp: Date.now()
      },
      'ProjectStateManager'
    );
  }
}
```

### 2. イベント購読の徹底

すべての関連コンポーネントが必要なイベントを適切に購読するように修正します。特にモックアップギャラリーパネルのような独立したコンポーネントを重点的に改修します。

```typescript
// モックアップギャラリーパネルのイベント購読改善
private _setupEventSubscriptions(): void {
  const eventBus = AppGeniusEventBus.getInstance();
  
  // プロジェクト更新イベントを購読
  this._disposables.push(
    eventBus.onEventType(AppGeniusEventType.PROJECT_UPDATED, (event) => {
      if (event.data && event.data.project) {
        const project = event.data.project;
        if (this._projectPath !== project.path) {
          Logger.info(`プロジェクト更新イベントを受信: ${project.name}, ${project.path}`);
          this._updateProjectPath(project.path);
        }
      }
    })
  );
}
```

### 3. 状態更新プロセスの改善

状態更新の一貫性を確保するため、更新処理を非同期対応に改善します。

```javascript
// stateManager.jsの改善例
async handleUpdateState(data) {
  // すでに処理中なら待機キューに追加
  if (this._isProcessingStateUpdate) {
    await this._enqueueStateUpdate(data);
    return;
  }
  
  this._isProcessingStateUpdate = true;
  
  try {
    // 状態更新ロジック
    await this._performStateUpdate(data);
    // リスナー通知
    this._notifyListeners();
  } finally {
    this._isProcessingStateUpdate = false;
    // 待機中の更新があれば処理
    this._processNextStateUpdate();
  }
}
```

### 4. パネル間の状態同期メカニズムの導入

パネル（タブ）が切り替わるときに、常に最新のプロジェクト状態が反映されるよう、明示的な同期メカニズムを導入します。

```typescript
// パネル表示時の状態同期
public async reveal(): Promise<void> {
  // パネルを表示
  this._panel.reveal();
  
  // 現在のアクティブプロジェクトで状態を同期
  const projectService = ProjectServiceImpl.getInstance();
  const activeProject = projectService.getActiveProject();
  
  if (activeProject) {
    await this._synchronizeWithProject(activeProject);
  }
}
```

### 5. ログとエラー処理の強化

問題の再発を迅速に特定できるよう、ログ記録とエラー処理を強化します。

```typescript
// 状態不一致検出用のログ強化
private _checkStateConsistency(): void {
  const projectService = ProjectServiceImpl.getInstance();
  const activeProject = projectService.getActiveProject();
  
  if (activeProject && this._projectPath !== activeProject.path) {
    Logger.warn(`状態の不一致を検出: パネルのプロジェクトパス=${this._projectPath}, アクティブプロジェクトパス=${activeProject.path}`);
    // 自動修正
    this._updateProjectPath(activeProject.path);
  }
}
```

## 実装計画

問題解決のための実装は、以下の順序で段階的に行うことを推奨します：

1. **状態管理の改善**: ProjectServiceImplとMessageDispatchServiceImplの責任分離
2. **イベント伝播の修正**: AppGeniusEventBusを介した適切なイベント発行と購読の実装
3. **WebView側の同期改善**: stateManager.jsの非同期処理対応と競合状態の解決
4. **タブ管理の改良**: タブ状態の永続化と復元プロセスの強化
5. **パネル固有の対応**: 各パネル（特にモックアップギャラリー）のプロジェクト切り替え対応

## おわりに

これらの改善を実装することで、プロジェクト切り替え機能の信頼性が向上し、ユーザー体験が改善されます。また、コンポーネント間の結合度が低下するため、将来の拡張性とメンテナンス性も向上します。