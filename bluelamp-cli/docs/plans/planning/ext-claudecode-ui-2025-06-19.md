# 機能拡張計画: ClaudeCode風UI実装 2025-06-19

## 1. 拡張概要

BlueLamp CLIの現在のreadlineベースの入力インターフェースを、ClaudeCodeのような洗練されたチャットUIに変更する。画面下部に固定された入力欄、動的に拡張する入力エリア、IME対応のエンター送信、そして上部のスクロール可能な出力エリアを実装することで、より直感的で使いやすいユーザー体験を提供する。

## 2. 詳細仕様

### 2.1 現状と課題

現在のBlueLamp CLIは標準的なreadlineインターフェースを使用しており、以下の制限がある：
- Ctrl+Dでの送信という非直感的な操作
- 複数行入力時の視認性の低さ
- 出力と入力が混在する従来型のターミナルUI
- 日本語入力（IME）との相性の悪さ

### 2.2 拡張内容

ClaudeCodeのUIを参考に、以下の機能を実装する：

1. **チャット風レイアウト**
   - 出力エリア：画面上部のスクロール可能な領域
   - 入力エリア：画面下部に固定配置
   - 明確な視覚的分離

2. **入力エリアの動的拡張**
   - 初期状態：1行の高さ
   - テキスト入力に応じて自動的に高さを拡張
   - 画面全体まで拡張可能

3. **IME対応のエンター送信**
   - IME変換中：エンターで変換確定
   - 確定済み状態：エンターで送信
   - Shift+Enter：改行（\マーカー付き）

4. **ペースト処理**
   - 複数行のペーストをそのまま入力欄に反映
   - 大量テキストの折りたたみ表示（6行以上）
   - 送信時に全文を出力欄に展開

## 3. ディレクトリ構造

```
bluelamp-cli/
├── src/
│   ├── core/
│   │   ├── cli.ts                    # 既存（UIインターフェースとの統合部分を修正）
│   │   └── ui/                       # 新規ディレクトリ
│   │       ├── index.ts              # UIインターフェースのエクスポート
│   │       ├── chat-interface.ts     # メインのチャットUIクラス
│   │       ├── input-handler.ts      # 入力処理ロジック
│   │       ├── output-renderer.ts    # 出力レンダリング
│   │       └── ime-detector.ts       # IME状態検出
│   └── index.ts                      # 既存（変更なし）
├── package.json                      # 依存関係追加
└── tsconfig.json                     # 既存（変更なし）
```

## 4. 技術的影響分析

### 4.1 影響範囲

- **フロントエンド**: 該当なし（CLIアプリケーション）
- **バックエンド**: 該当なし（ローカル実行）
- **データモデル**: 変更なし
- **その他**: 
  - ターミナルエミュレータとの互換性確認が必要
  - SSH経由での動作確認が必要

### 4.2 変更が必要なファイル

```
- src/core/cli.ts: UIインターフェースの初期化と統合部分の修正
- package.json: 新しいUI依存関係の追加（blessed、neo-blessed、またはink）
- src/core/terminal-kit-interface.ts: 削除（未使用のため）
```

## 5. タスクリスト

```
- [ ] **T1**: 技術選定とプロトタイプ作成
  - UIライブラリの選定（blessed vs ink vs カスタム実装）
  - 最小限のチャットUIプロトタイプ作成
  - IME対応の検証

- [ ] **T2**: 基本UIレイアウトの実装
  - 画面分割（出力エリア/入力エリア）
  - スクロール可能な出力エリア
  - 固定位置の入力エリア

- [ ] **T3**: 入力処理の実装
  - IME状態検出とエンター処理の分岐
  - Shift+Enterでの改行（\マーカー）
  - 入力エリアの動的高さ調整

- [ ] **T4**: ペースト処理とテキスト折りたたみ
  - ペースト検出または大量テキスト処理
  - 折りたたみ表示の実装
  - 送信時の全文展開

- [ ] **T5**: 既存CLIとの統合
  - UnifiedCLIクラスとの接続
  - エージェント出力の適切な表示
  - エラーハンドリング

- [ ] **T6**: テストとデバッグ
  - 各種ターミナルでの動作確認
  - SSH接続での動作確認
  - 日本語入力の完全なテスト
```

## 6. テスト計画

1. **機能テスト**
   - 単一行入力での送信
   - 複数行入力（Shift+Enter）での送信
   - IME使用時の動作確認
   - ペースト時の動作確認

2. **互換性テスト**
   - macOS Terminal.app
   - iTerm2
   - VS Code統合ターミナル
   - SSH経由での動作

3. **パフォーマンステスト**
   - 大量出力時のスクロール性能
   - 長時間実行時のメモリ使用量

## 7. SCOPE_PROGRESSへの統合

このプロジェクトにはSCOPE_PROGRESS.mdが存在しないため、新規作成して以下のタスクを追加：

```markdown
- [ ] **UI-001**: ClaudeCode風UIの実装
  - 目標: 2025-06-26
  - 参照: [/docs/plans/planning/ext-claudecode-ui-2025-06-19.md]
  - 内容: readlineベースのUIをClaudeCode風のチャットUIに変更
```

## 8. 備考

### 技術選定の考慮事項

1. **blessed/neo-blessed**
   - 利点：豊富なUI要素、安定性
   - 欠点：メンテナンス状況、パフォーマンス

2. **React Ink**
   - 利点：モダンなReactベース、ClaudeCodeと同じ技術
   - 欠点：学習コスト、依存関係の増加

3. **カスタム実装（readline拡張）**
   - 利点：軽量、制御性
   - 欠点：開発工数、機能制限

### リスクと対策

- **IME対応の複雑さ**: 各OS/ターミナルでの十分なテストが必要
- **既存機能への影響**: 段階的な移行とフォールバック機能の実装
- **パフォーマンス**: 出力バッファリングとスマートレンダリングの実装