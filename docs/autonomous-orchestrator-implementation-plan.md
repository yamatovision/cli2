# BlueLamp CLI 自律的オーケストレーター実装計画書

**作成日**: 2025-06-23
**更新日**: 2025-06-25
**バージョン**: 2.0
**対象**: 16エージェントプロンプトを活用したマルチエージェントシステム

## 1. プロジェクト概要

### 1.1 目標
16種類の専門エージェントプロンプト（`/16agents/`）を活用し、OpenHandsライクな自律的マルチエージェントシステムを構築する。

### 1.2 核心的な設計思想
- **ルールベースオーケストレーター**: コンテキスト消費を最小限に抑制
- **専門エージェントの自律性**: 各エージェントが独立したAIセッションで動作
- **階層的コンテキスト管理**: 200kトークン制約を効率的に回避
- **視覚的進捗表示**: リアルタイムでエージェント活動を可視化

## 2. 現在の制約事項（2025-06-25更新）

### 2.1 OpenHandsの設計制約

#### できること ✅
1. **単一エージェントの実行**
   - 1つのCLIセッションで1つのエージェントが動作
   - コマンドライン引数でエージェントを指定可能（`-c AgentName`）

2. **DELEGATE機能による逐次委譲**
   - `AgentDelegateAction`を使った子エージェントへの委譲
   - 委譲時に新しいコンテキスト（ほぼ0から）で開始
   - 親エージェントは子の完了を待って再開

3. **ファイルベースの情報共有**
   - 各エージェントがファイルシステムを通じて情報共有
   - SCOPE_PROGRESS.mdなどの進捗管理

4. **プロンプトファイルによるエージェント動作カスタマイズ**
   - 各エージェント用のプロンプトテンプレート作成可能

#### できないこと ❌
1. **並列エージェント実行**
   - 複数エージェントの同時実行は不可能
   - DELEGATE機能はスタック構造（逐次処理のみ）

2. **動的なエージェント切り替え**
   - 実行中にエージェントタイプを変更できない
   - 新しいエージェントは新しいセッションが必要

3. **エージェント間の直接通信**
   - エージェント同士が直接メッセージをやり取りできない
   - すべてファイル経由での非同期通信

4. **複雑な状態管理**
   - オーケストレーターが複数エージェントの状態を管理できない
   - 各エージェントは独立して動作

### 2.2 実装上の課題

1. **ループ問題**
   - 同じメッセージを繰り返し処理する可能性
   - StuckDetectorによりエラーで終了

2. **コンテキスト管理**
   - DELEGATEを使えば新しいコンテキストで開始可能
   - ただし、親の履歴は引き継がれない

3. **エラーハンドリング**
   - エージェントがERROR状態になるとCLI全体が終了

## 3. 実現可能な実装アプローチ

### 3.1 アプローチ1: シンプルなDELEGATEベースコンシェルジュ

```python
class ConciergeAgent(Agent):
    """ユーザーのリクエストを適切なエージェントに委譲"""

    def step(self, state: State) -> Action:
        # ユーザー入力を分析
        target_agent = self._determine_target_agent(user_message)

        if target_agent:
            # DELEGATEで委譲（逐次実行）
            return AgentDelegateAction(
                agent=target_agent,
                inputs={"task": user_message}
            )

        return MessageAction(content="適切なエージェントが見つかりません")
```

**メリット**:
- OpenHandsの設計に準拠
- 実装がシンプル
- 各エージェントが独立したコンテキスト

**デメリット**:
- 並列実行不可
- 単純な逐次処理のみ

### 3.2 アプローチ2: 外部ツールによるエージェント管理

```bash
#!/bin/bash
# bluelamp-orchestrator.sh

case "$1" in
  "requirements")
    bluelamp -c CodeActAgent -t "要件定義を作成"
    ;;
  "ui-design")
    bluelamp -c CodeActAgent -t "UIデザインを作成"
    ;;
  *)
    echo "利用可能なエージェント..."
    ;;
esac
```

**メリット**:
- 完全に独立したセッション
- 並列実行可能（別ターミナル）
- シンプルで確実

**デメリット**:
- 自動化が困難
- エージェント間の連携が手動

### 3.3 アプローチ3: ハイブリッド方式

1. **メインコンシェルジュ**（DELEGATE使用）
   - ユーザー対話を担当
   - タスクの振り分け
   - 逐次的なワークフロー管理

2. **外部スクリプト**（並列実行用）
   - 独立性の高いタスクを別プロセスで実行
   - 結果をファイル経由で共有

## 4. 実装計画（改訂版）

### Phase 1: 基本実装（1週間）

1. **シンプルなコンシェルジュエージェント作成**
   - DELEGATE機能を使った基本的な委譲
   - エージェント選択ロジック
   - エラーハンドリング

2. **プロンプトテンプレート整備**
   - 16エージェント用のプロンプトファイル作成
   - 役割と責任の明確化

### Phase 2: ワークフロー実装（1週間）

1. **タスク管理システム**
   - SCOPE_PROGRESS.mdベースの進捗管理
   - タスクの依存関係定義
   - 逐次実行の最適化

2. **エラーリカバリー**
   - エラー時の適切な処理
   - 進捗の保存と再開

### Phase 3: ユーザビリティ向上（1週間）

1. **インタラクティブUI**
   - 進捗の可視化
   - エージェント状態表示
   - ユーザーフィードバック機能

2. **外部ツール連携**
   - 並列実行用スクリプト
   - 結果集約ツール

## 5. 期待される成果（現実的な目標）

### 5.1 実現可能な機能
- ✅ 16エージェントへの適切なタスク振り分け
- ✅ 逐次的なワークフロー実行
- ✅ 各エージェントの独立したコンテキスト管理
- ✅ ファイルベースの進捗管理
- ✅ エラー時の適切なハンドリング

### 5.2 制限事項
- ❌ 真の並列実行（外部ツール使用時のみ可能）
- ❌ リアルタイムなエージェント間通信
- ❌ 複雑な状態管理とオーケストレーション
- ❌ 動的なエージェント生成と破棄

## 6. リスクと対策

### 6.1 技術的リスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| DELEGATEの制約 | 高 | 逐次処理に最適化した設計 |
| ループ問題 | 中 | 適切な状態管理と処理済みチェック |
| エラーでCLI終了 | 中 | エラーハンドリングの強化 |

### 6.2 運用リスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| 処理時間の長期化 | 中 | タスクの適切な分割 |
| ユーザー体験の低下 | 低 | 進捗表示の充実 |

## 7. 結論

当初の計画にあった完全自律的なマルチエージェントシステムは、OpenHandsの現在の設計では実現困難です。しかし、以下のアプローチにより、実用的なシステムを構築できます：

1. **DELEGATE機能を活用した逐次処理システム**
2. **外部ツールによる並列実行の補完**
3. **ファイルベースの情報共有**

これにより、16エージェントの専門性を活かしながら、現実的で安定したシステムを実現できます。

---

**注記**: この計画書は、実際の実装経験に基づいて更新されました。当初の野心的な目標から、OpenHandsの制約を考慮した現実的なアプローチに修正しています。
