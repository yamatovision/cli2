# リファクタリング計画: プラットフォーム分離 2025-06-25

## 1. 現状分析

### 1.1 対象概要
AppGeniusプロジェクトの3つのプラットフォーム（VSCode拡張機能、CLI、ポータル）が単一ディレクトリに混在している状況を、セキュリティとメンテナンス性の観点から分離する。特に、VSCodeマーケットプレイス公開時に機密情報が漏洩するリスクを完全に排除する。

### 1.2 問題点と課題
- **セキュリティリスク**: VSCode拡張機能ディレクトリに機密プロンプトファイルが混在
- **機密情報の漏洩**: `docs/deployment/deploy.md`にPersonal Access Token等が平文記載
- **重複ファイル**: `16agents/`と`OpenHands-main/microagents/`で同様のファイルが重複
- **不適切な.vscodeignore**: 機密ディレクトリが除外設定されていない
- **プラットフォーム間の依存**: 各プラットフォームが独立して動作できない

### 1.3 関連ファイル一覧

**機密ファイル（移動対象）:**
- `16agents/` - 16個のエージェントプロンプトファイル
- `docs/` - 設計ドキュメント、デプロイ情報（PAT含む）
- `mockups/` - 開発用モックアップファイル
- `convert-agents.js` - エージェント変換スクリプト

**VSCode拡張機能（保持対象）:**
- `src/` - TypeScriptソースコード
- `media/` - UI関連ファイル
- `dist/` - ビルド済みファイル
- `package.json`, `CHANGELOG.md`, `README.md` - 設定・ドキュメント
- `node_modules/` - 依存関係
- `.vscodeignore`, `tsconfig.json`, `webpack.config.js` - 設定ファイル

**既存プラットフォーム:**
- `OpenHands-main/` - CLI（既存）
- `portal/` - Webポータル（既存）

### 1.4 依存関係図
```
現在の構造:
AppGenius/
├── [VSCode拡張機能ファイル] ← 公開される
├── [機密ファイル] ← 漏洩リスク
├── OpenHands-main/ ← CLI
└── portal/ ← Webポータル

理想の構造:
AppGenius/
├── vscode-extension/ ← 公開用（機密情報なし）
├── cli/ ← CLI（OpenHands-main）
├── portal/ ← Webポータル
└── private/ ← 機密ファイル（非公開）
```

## 2. リファクタリングの目標

### 2.1 期待される成果
- **セキュリティ向上**: 機密情報の完全分離により漏洩リスクを0にする
- **メンテナンス性向上**: プラットフォーム別の独立した開発・デプロイが可能
- **公開安全性**: VSCode拡張機能の安全な公開が可能
- **コード削減**: 重複ファイルの統合により約30%のファイル削減
- **開発効率向上**: 各プラットフォームの責任分離による開発効率向上

### 2.2 維持すべき機能
- VSCode拡張機能の全機能（認証、UI、API連携等）
- CLI（OpenHands）の全機能
- Webポータルの全機能
- 各プラットフォーム間の連携機能

## 3. 理想的な実装

### 3.1 全体アーキテクチャ
```
AppGenius/
├── vscode-extension/          # VSCode拡張機能（公開用）
│   ├── src/                   # TypeScriptソースコード
│   ├── media/                 # UI関連ファイル
│   ├── dist/                  # ビルド済みファイル
│   ├── package.json           # 拡張機能設定
│   ├── README.md              # 公開用ドキュメント
│   ├── CHANGELOG.md           # リリースノート
│   ├── .vscodeignore          # 厳格な除外設定
│   └── [その他設定ファイル]
│
├── cli/                       # CLI（OpenHands-main）
│   ├── openhands/             # CLIコア
│   ├── microagents/           # エージェントファイル
│   ├── docs/                  # CLI専用ドキュメント
│   └── [CLI関連ファイル]
│
├── portal/                    # Webポータル（既存）
│   ├── frontend/              # React フロントエンド
│   ├── backend/               # Node.js バックエンド
│   └── [ポータル関連ファイル]
│
└── private/                   # 機密ファイル（非公開）
    ├── agents/                # 16agents プロンプトファイル
    ├── docs/                  # 設計ドキュメント
    ├── mockups/               # 開発用モックアップ
    ├── scripts/               # 開発用スクリプト
    └── deployment/            # デプロイ情報（PAT等）
```

### 3.2 核心的な改善ポイント
1. **完全な機密情報分離**: privateディレクトリで機密情報を完全隔離
2. **プラットフォーム独立性**: 各ディレクトリが独立して動作可能
3. **厳格な.vscodeignore**: VSCode拡張機能で機密情報を完全除外
4. **重複排除**: エージェントファイルをcli/microagentsに統合
5. **セキュアなデプロイ**: 機密情報を含まない安全な公開プロセス

### 3.3 新しいディレクトリ構造
```
AppGenius/
├── vscode-extension/
├── cli/
├── portal/
└── private/
```

## 4. 実装計画

### フェーズ1: 準備とディレクトリ作成
- **目標**: 新しいディレクトリ構造の準備
- **影響範囲**: ルートディレクトリ
- **タスク**:
  1. **T1.1**: 新しいディレクトリ構造の作成
     - 対象: ルートディレクトリ
     - 実装: `vscode-extension/`, `cli/`, `private/` ディレクトリを作成
  2. **T1.2**: 既存ディレクトリの名前変更
     - 対象: `OpenHands-main/`
     - 実装: `cli/` に名前変更
- **検証ポイント**:
  - 新しいディレクトリ構造が正しく作成されている
  - 既存の`portal/`ディレクトリが影響を受けていない

### フェーズ2: VSCode拡張機能ファイルの移動
- **目標**: VSCode拡張機能の安全な分離
- **影響範囲**: VSCode拡張機能関連ファイル
- **タスク**:
  1. **T2.1**: 必要ファイルの移動
     - 対象: `src/`, `media/`, `dist/`, `package.json`, `CHANGELOG.md`
     - 実装: `vscode-extension/` ディレクトリに移動
  2. **T2.2**: 設定ファイルの移動と更新
     - 対象: `.vscodeignore`, `tsconfig.json`, `webpack.config.js`
     - 実装: 移動後、パス設定を更新
  3. **T2.3**: 厳格な.vscodeignoreの作成
     - 対象: `vscode-extension/.vscodeignore`
     - 実装: 機密ディレクトリを完全除外する設定
- **検証ポイント**:
  - VSCode拡張機能が正常にビルドできる
  - 機密ファイルが含まれていない
  - 全ての機能が正常に動作する

### フェーズ3: 機密ファイルの移動
- **目標**: 機密情報の完全分離
- **影響範囲**: 機密ファイル
- **タスク**:
  1. **T3.1**: エージェントファイルの移動
     - 対象: `16agents/`
     - 実装: `private/agents/` に移動
  2. **T3.2**: ドキュメントファイルの移動
     - 対象: `docs/`
     - 実装: `private/docs/` に移動
  3. **T3.3**: 開発ファイルの移動
     - 対象: `mockups/`, `convert-agents.js`
     - 実装: `private/` 配下に移動
  4. **T3.4**: 機密情報のサニタイズ
     - 対象: `private/docs/deployment/deploy.md`
     - 実装: Personal Access Token等の機密情報を削除または暗号化
- **検証ポイント**:
  - 機密ファイルがVSCode拡張機能ディレクトリに存在しない
  - 機密情報が適切に保護されている
  - 必要なファイルが正しい場所に配置されている

### フェーズ4: CLIディレクトリの整理
- **目標**: CLI関連ファイルの統合と整理
- **影響範囲**: CLI関連ファイル
- **タスク**:
  1. **T4.1**: OpenHands-mainの名前変更
     - 対象: `OpenHands-main/`
     - 実装: `cli/` に名前変更
  2. **T4.2**: 重複エージェントファイルの統合
     - 対象: `cli/microagents/` と `private/agents/`
     - 実装: 最新版を`cli/microagents/`に統合、重複を削除
  3. **T4.3**: CLI専用ドキュメントの整理
     - 対象: `cli/docs/`
     - 実装: CLI関連ドキュメントのみ保持
- **検証ポイント**:
  - CLIが正常に動作する
  - エージェントファイルの重複が解消されている
  - CLI専用ドキュメントが適切に配置されている

### フェーズ5: 設定ファイルの更新と検証
- **目標**: 各プラットフォームの独立動作確認
- **影響範囲**: 設定ファイル、ビルドスクリプト
- **タスク**:
  1. **T5.1**: VSCode拡張機能の設定更新
     - 対象: `vscode-extension/package.json`, `vscode-extension/webpack.config.js`
     - 実装: パス設定の更新、依存関係の確認
  2. **T5.2**: CLIの設定更新
     - 対象: `cli/` 配下の設定ファイル
     - 実装: パス設定の更新
  3. **T5.3**: ポータルの設定確認
     - 対象: `portal/` 配下の設定ファイル
     - 実装: 影響がないことを確認
  4. **T5.4**: 統合テストの実行
     - 対象: 全プラットフォーム
     - 実装: 各プラットフォームの動作確認
- **検証ポイント**:
  - VSCode拡張機能が正常にビルド・動作する
  - CLIが正常に動作する
  - ポータルが正常に動作する
  - プラットフォーム間の連携が正常に機能する

## 5. 期待される効果

### 5.1 コード削減
- 重複ファイルの削除により約30%のファイル削減
- 不要なドキュメントファイルの整理により約50%のドキュメント削減

### 5.2 保守性向上
- プラットフォーム別の独立した開発・デプロイが可能
- 機密情報の管理が一元化され、セキュリティリスクが大幅に軽減
- 各プラットフォームの責任分離により、開発効率が向上

### 5.3 拡張性改善
- 新しいプラットフォームの追加が容易
- 各プラットフォームの独立したバージョン管理が可能
- セキュアな公開プロセスの確立

## 6. リスクと対策

### 6.1 潜在的リスク
- **ファイル移動時のパス参照エラー**: 設定ファイルやインポート文でのパス参照が無効になる可能性
- **ビルドプロセスの破綻**: webpack設定やTypeScript設定の不整合
- **機能の一部欠損**: ファイル移動時の見落としによる機能欠損
- **プラットフォーム間連携の破綻**: 相互参照している機能の動作不良

### 6.2 対策
- **段階的移行**: フェーズ別に実行し、各段階で動作確認を実施
- **バックアップの作成**: 各フェーズ開始前にGitコミットでバックアップ
- **包括的テスト**: 各フェーズ完了後に全機能のテストを実行
- **ロールバック計画**: 問題発生時の迅速なロールバック手順を準備

## 7. 備考

### 7.1 セキュリティ強化
- Personal Access Tokenや秘密鍵は環境変数または暗号化ファイルで管理
- `.vscodeignore`の厳格な設定により、機密情報の漏洩を完全防止
- 各プラットフォームの独立性により、セキュリティ境界を明確化

### 7.2 今後の運用
- VSCode拡張機能の公開時は`vscode-extension/`ディレクトリのみを対象
- 機密情報は`private/`ディレクトリで一元管理
- 各プラットフォームの開発は独立したディレクトリで実施

### 7.3 代替案
もし現在の構造を大幅に変更することが困難な場合は、最低限以下の対策を実施：
1. 厳格な`.vscodeignore`の設定
2. 機密情報を含むファイルの暗号化または削除
3. Personal Access Token等の環境変数化