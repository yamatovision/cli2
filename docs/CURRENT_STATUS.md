# ScopeManagerPanel 段階的リファクタリング実装計画

## 1. 概要

このドキュメントは、大規模な`media/scopeManager.js`ファイルの保守性と拡張性を向上させるための段階的リファクタリング計画です。「骨を残して肉を入れ替える」アプローチを採用し、常に動作する状態を維持しながら、少しずつモジュール化を進めます。

## 2. 目標

1. 単一責任の原則に従った関数・モジュールの整理
2. 常に動作する状態を維持する段階的リファクタリング
3. 各ステップでの確実な動作検証
4. 将来の機能拡張をしやすくする設計の実現

## 3. リファクタリングの基本方針

### 3.1 「骨を残して肉を入れ替える」アプローチ

1. **既存構造を維持**: 既存のscopeManager.jsの基本構造は保持
2. **関数単位の移動**: 機能ごとに関数を特定し、それを新ファイルに移動
3. **インポート導入**: 移動した関数をインポートして使うよう修正
4. **動作検証**: 各ステップで必ず動作確認を行う

### 3.2 段階的進行ステップ

1. **バックアップ作成**: 作業前に必ずバックアップを作成
2. **関数分析**: 移動する関数とその依存関係を特定
3. **モジュール作成**: 新ファイルを作成し、関数を移植
4. **修正と統合**: 元ファイルを修正し、新モジュールをインポート
5. **検証**: 機能が正常に動作することを確認
6. **クリーンアップ**: 冗長部分の削除、コード最適化

## 4. ディレクトリ構造

```
media/
├── scopeManager.js → 段階的に縮小していくメインファイル
├── components/
│   ├── markdownViewer/
│   │   ├── markdownViewer.js  → マークダウン表示関連機能
│   │   └── markdownViewer.css
│   ├── tabManager/
│   │   ├── tabManager.js      → タブ切替関連機能
│   │   └── tabManager.css
│   ├── projectNavigation/
│   │   ├── projectNavigation.js → プロジェクト管理関連機能
│   │   └── projectNavigation.css
│   ├── dialogManager/
│   │   ├── dialogManager.js   → ダイアログと通知関連機能
│   │   └── dialogManager.css
│   └── sharingPanel.js (既存)
├── state/
│   └── stateManager.js        → 状態管理関連機能
└── utils/
    ├── markdownConverter.js   → マークダウン変換関連機能
    ├── messageHandler.js      → メッセージ処理関連機能
    └── uiHelpers.js           → UI操作のヘルパー関数
```

## 5. 機能の分類と移行候補

### 5.1 状態管理関連
- `getState()`, `setState()`
- `syncProjectState()`
- `restoreProjectState()`
- 状態初期化処理

### 5.2 マークダウン変換関連
- `convertMarkdownToHtml()`
- `enhanceSpecialElements()`
- `setupCheckboxes()`

### 5.3 UI操作ヘルパー関連
- 表示/非表示切り替え関数
- DOM要素作成関数
- アニメーション関連関数

### 5.4 メッセージ処理関連
- `handleUpdateState()`
- `handleGetMarkdownContent()`
- メッセージ受信イベント処理

### 5.5 タブ管理関連
- `initializeTabs()`
- `selectTab()`
- タブ切替処理

### 5.6 マークダウン表示関連
- `displayMarkdownContent()`
- `initializeMarkdownDisplay()`

### 5.7 プロジェクト管理関連
- `updateProjectPath()`
- `updateProjects()`
- プロジェクトナビゲーション処理

### 5.8 ダイアログと通知関連
- `showError()`, `showSuccess()`
- モーダルダイアログ処理

## 6. 具体的な実装ステップ

### フェーズ1: 準備と現状分析

- [x] **タスク1.1: 状態と依存関係の分析**
  - 既存コードの関数とその依存関係を調査
  - 移行順序を決定するための優先度付け

- [x] **タスク1.2: バックアップと環境準備**
  - 現状のscopeManager.jsをバックアップ
  - 新しいディレクトリ構造の作成

- [x] **タスク1.3: モジュール化テンプレート準備**
  - ESモジュールのテンプレート作成
  - インポート/エクスポート方法の確立

### フェーズ2: マークダウン変換機能の分離

- [x] **タスク2.1: マークダウン変換関数の特定**
  - `convertMarkdownToHtml()` 他、関連する補助関数を特定
  - 依存関係と影響範囲を分析

- [x] **タスク2.2: markdownConverter.js の作成**
  - 最小限の依存で機能するモジュール構造の実装
  - エクスポート関数の定義

- [x] **タスク2.3: scopeManager.js の修正**
  - 変換関数の呼び出しをインポート版に置き換え
  - 直接定義を削除し、インポートステートメントを追加

- [x] **タスク2.4: 動作検証**
  - マークダウン表示機能が正常に動作することを確認
  - 変換結果が元のコードと同一であることを確認

#### フェーズ2の実装完了サマリー
- ScopeManagerPanel.tsにスクリプトタグの`type="module"`属性を追加し、ES Modulesのインポート機能を有効化
- マークダウン変換関連のすべての関数を`markdownConverter.js`に移動
- `scopeManager.js`で`import { convertMarkdownToHtml, enhanceSpecialElements, setupCheckboxes } from './utils/markdownConverter.js';`を追加
- 機能の検証を実施し、マークダウン表示が正常に動作することを確認

### フェーズ3: 状態管理機能の分離

- [ ] **タスク3.1: 状態管理関数の特定**
  - `getState()`, `setState()` などの関数を特定
  - VSCodeの状態APIに依存する部分を特定

- [ ] **タスク3.2: stateManager.js の作成**
  - VSCode状態APIと連携する機能の実装
  - 状態更新通知機能の追加

- [ ] **タスク3.3: scopeManager.js の修正**
  - 状態管理呼び出しをstateManagerに置き換え
  - 直接の状態操作コードを削除

- [ ] **タスク3.4: 動作検証**
  - 状態保存・復元が正常に動作するか確認
  - 状態変更イベントが正しく発火するか確認

### フェーズ4: UIヘルパー関数の分離

- [ ] **タスク4.1: UIヘルパー関数の特定**
  - DOM操作、表示制御などの共通関数を特定
  - 再利用可能な関数の抽出

- [ ] **タスク4.2: uiHelpers.js の作成**
  - 汎用的なUI操作関数の実装
  - 必要に応じてクラス化

- [ ] **タスク4.3: scopeManager.js の修正**
  - UIヘルパー関数の呼び出しを置き換え
  - 直接定義を削除

- [ ] **タスク4.4: 動作検証**
  - UI操作が正常に機能することを確認
  - レンダリング結果が一致することを確認

### フェーズ5: メッセージハンドラの分離

- [ ] **タスク5.1: メッセージ処理関数の特定**
  - 各種メッセージハンドラを特定
  - コマンド処理の依存関係を分析

- [ ] **タスク5.2: messageHandler.js の作成**
  - メッセージ受信と振り分け処理の実装
  - 個別ハンドラ関数の実装

- [ ] **タスク5.3: scopeManager.js の修正**
  - メッセージ処理を新モジュールに置き換え
  - 元の処理コードを削除

- [ ] **タスク5.4: 動作検証**
  - メッセージ処理が正常に機能するか確認
  - 各コマンドが適切に処理されるか確認

### フェーズ6: UIコンポーネントの分離

- [ ] **タスク6.1: タブ管理の分離**
  - タブ関連処理の特定と移動
  - tabManager.js の作成と統合

- [ ] **タスク6.2: マークダウンビューアの分離**
  - マークダウン表示処理の特定と移動
  - markdownViewer.js の作成と統合

- [ ] **タスク6.3: プロジェクトナビゲーションの分離**
  - プロジェクト管理処理の特定と移動
  - projectNavigation.js の作成と統合

- [ ] **タスク6.4: ダイアログ管理の分離**
  - ダイアログ処理の特定と移動
  - dialogManager.js の作成と統合

- [ ] **タスク6.5: 統合動作検証**
  - すべてのコンポーネントの連携確認
  - UI動作の一貫性確認

### フェーズ7: メインファイルの最適化

- [ ] **タスク7.1: 初期化処理の整理**
  - 各モジュールの初期化呼び出しを整理
  - モジュール間の依存関係を最適化

- [ ] **タスク7.2: 冗長処理の削除**
  - 不要になった関数や変数を削除
  - コード重複の排除

- [ ] **タスク7.3: 最終検証**
  - 全機能の総合テスト
  - パフォーマンス確認

## 7. 各ステップでの検証項目

### 7.1 機能検証
- マークダウン表示が正常に機能するか
- タブ切り替えが正常に動作するか
- プロジェクト選択と表示が正常に動作するか
- 状態保存と復元が正常に機能するか
- エラー表示とダイアログが正常に表示されるか

### 7.2 パフォーマンス検証
- ページ読み込み時間に悪影響がないか
- 大量データ処理が正常に動作するか
- メモリ使用量に問題がないか

### 7.3 互換性検証
- 既存の機能がすべて正常に動作するか
- 既存のイベントハンドリングが正常に機能するか
- バックエンドとの連携が正常に動作するか

## 8. リスク対策

### 8.1 動作不良対策
- 各ステップで必ずバックアップを作成
- 変更は小さく、検証可能な単位で実施
- 問題発生時に前のバージョンに戻せるよう準備

### 8.2 依存関係の見落とし対策
- 関数の使用箇所を完全に特定してから移行
- 移行後も元のコードを残し、動作比較を実施
- コンソールログによる動作確認を徹底

### 8.3 モジュール間循環参照対策
- 依存関係を明確にし、循環を避ける設計
- 必要に応じてイベント駆動型の疎結合設計の採用
- 共通機能は下位レイヤーに配置する階層構造の維持

## 9. 期待される成果

1. **保守性の向上**:
   - 機能ごとに分離された小さなモジュール
   - 関心の分離による理解しやすいコード

2. **拡張性の向上**:
   - 機能追加時の影響範囲の局所化
   - 独立したモジュールによる並行開発の容易化

3. **品質の向上**:
   - バグの発見と修正が容易に
   - テスト可能性の向上

4. **開発効率の向上**:
   - 変更に要する時間の短縮
   - 新メンバーの学習コスト低減

## 10. タイムライン

総所要時間: 約20時間（各ステップの検証時間を含む）

- フェーズ1 (準備): 2時間 ✅ 完了
- フェーズ2 (マークダウン変換): 3時間 ✅ 完了
- フェーズ3 (状態管理): 3時間 🔄 進行中
- フェーズ4 (UIヘルパー): 2時間
- フェーズ5 (メッセージハンドラ): 3時間
- フェーズ6 (UIコンポーネント): 5時間
- フェーズ7 (最適化): 2時間

## 11. 進捗状況 (2025年5月3日更新)

### 完了フェーズ
- **フェーズ1** ✅: 構造分析、ディレクトリ準備、モジュール化テンプレート準備
- **フェーズ2** ✅: マークダウン変換機能の分離完了
- **フェーズ4** ✅: UIヘルパー関数の分離完了
  - showError, showSuccess, getStatusClass, getStatusText, getTimeAgo関数を移行
  - 不要なディレクトリ構造表示機能も整理済み

### 進行中フェーズ
- **フェーズ3** ⚠️: 状態管理機能の分離 - 一時停止
  - 依存関係の複雑さにより一度の移行が困難と判明
  - 段階的なアプローチを再検討中
  
### 次のステップ
1. **フェーズ5** 🔜: メッセージハンドラの分離
   - messageHandler.jsの基本構造は作成済み
   - メッセージ処理関連のコードを段階的に移行予定
2. 状態管理（フェーズ3）は最小限の修正単位で後日再検討