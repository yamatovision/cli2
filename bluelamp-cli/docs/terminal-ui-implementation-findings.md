# Terminal UI実装調査結果と知見

## 概要

BlueLamp CLIにClaudeCode風のUIを実装するための技術調査と実装試行の結果をまとめる。

## 技術選定の調査結果

### 1. blessed / neo-blessed ❌

**評価結果**: 使用不可

**理由**:
- 10年以上メンテナンスされていない（blessed: v0.1.81、neo-blessed: v0.2.0）
- **日本語IME入力が実質不可能**（最も致命的）
- 将来的なセキュリティリスク
- 新しいターミナル機能への対応なし

### 2. React Ink ⚠️

**評価結果**: 制限が多すぎる

**理由**:
- **ネイティブスクロール機能が存在しない**（チャットUIには致命的）
- ターミナル高さを超える出力の処理が困難
- 日本語IMEサポートが不十分
- ClaudeCodeが使用している可能性はあるが、確証なし

**利点**:
- Reactベースで開発しやすい
- 大手企業での採用実績（GitHub Copilot CLI、Cloudflare Wrangler等）
- モダンなアプローチ

### 3. terminal-kit ✅（条件付き）

**評価結果**: 実装可能だが課題あり

**現在の実装状況**:
- 基本的なUIレイアウトは実装完了
- 画面分割、ボーダー描画、ステータスライン表示は動作
- スクロール可能な出力エリアの実装済み

**実装で判明した問題**:
1. **エンター入力が動作しない**（致命的）
   - キーイベントは検出されているが、'input'イベントが発火しない
   - デバッグが必要

2. **出力の重複問題**
   - redrawOutput()の呼び出しタイミングの問題
   - 画面更新のロジックに改善が必要

3. **ターミナルサイズの検出問題**
   - 初期状態でInfinity×Infinityが返される
   - process.stdout.columns/rowsからの値で回避

### 4. カスタム実装（readline + ANSI） 🔍

**評価結果**: 最も柔軟だが実装コストが高い

**利点**:
- 完全な制御が可能
- 軽量（外部依存なし）
- 要件に合わせた最適化が可能

**欠点**:
- 実装の複雑さ
- エッジケースの処理
- メンテナンスコスト

## 実装で得られた知見

### 1. 日本語入力（IME）対応の重要性

- ターミナルUIライブラリの多くがIMEを考慮していない
- Raw modeでのIME制御は非常に困難
- 変換中のエンター処理との競合を避ける必要がある

### 2. ClaudeCode風UIの要件整理

**必須要件**:
1. **固定レイアウト**
   - 出力エリア（上部、スクロール可能）
   - 入力エリア（下部、動的高さ調整）
   - 明確な視覚的分離

2. **入力処理**
   - エンターで送信（IME確定後）
   - Shift+Enterで改行（\マーカー付き）
   - ペースト時の適切な処理

3. **出力処理**
   - 過去の履歴をスクロールで確認可能
   - 新しい出力で自動スクロール
   - 長い行の適切な折り返し

### 3. terminal-kit実装の具体的な問題点

```typescript
// 問題のあるコード例
case 'ENTER':
  if (data.shift) {
    // Shift+Enter: 改行（\マーカー付き）
    this.inputBuffer += '\\n';
    // ...
  } else if (this.isInPasteMode) {
    // ペーストモード中: 改行のみ
    // ...
  } else {
    // Enter単体: 送信
    const text = this.inputBuffer;
    if (text && text.trim()) {
      this.emit('input', text); // ← ここが発火しない
      this.clearInput();
    }
  }
  break;
```

**推測される原因**:
- イベントエミッターの初期化順序
- grabInputのオプション設定
- ペーストモード検出の誤動作

### 4. 画面更新の最適化

**問題点**:
- 出力が追加されるたびに全画面を再描画
- ダブルバッファリングの欠如
- 差分更新の未実装

**改善案**:
```typescript
// ダメージ領域のみを更新
private updateDamageRegion(startLine: number, endLine: number) {
  for (let i = startLine; i <= endLine; i++) {
    this.renderLine(i);
  }
}
```

## 今後の推奨アプローチ

### 短期的解決策（1-2週間）

1. **terminal-kitの問題修正**
   - エンター入力の問題をデバッグ
   - 出力重複の解消
   - 基本的な動作の安定化

2. **代替ライブラリの評価**
   - blessed-contrib（blessedの拡張版）
   - inquirer（プロンプトUI専用）
   - 他のターミナルUIライブラリ

### 中長期的解決策（1ヶ月以上）

1. **カスタム実装への移行**
   - readline + ANSIエスケープシーケンス
   - 最小限の機能から段階的に実装
   - 日本語入力を最優先で設計

2. **ハイブリッドアプローチ**
   - 基本UIはterminal-kit
   - 入力処理はカスタム実装
   - 必要に応じて部分的に置き換え

## 実装チェックリスト

- [x] 基本レイアウト（画面分割）
- [x] 出力エリアのスクロール
- [x] 入力エリアの動的高さ調整
- [x] Shift+Enterでの改行（\マーカー）
- [x] ペースト検出ロジック
- [ ] **エンター送信の動作** ❌
- [ ] 出力重複の解消
- [ ] 日本語入力の完全対応
- [ ] スムーズなスクロール
- [ ] 長文ペーストの折りたたみ表示

## デバッグ用コード

```javascript
// エンター入力のデバッグ
this.term.on('key', (name, matches, data) => {
  console.error(`Key pressed: ${name}`, {
    isCharacter: data.isCharacter,
    shift: data.shift,
    ctrl: data.ctrl,
    code: data.code
  });
});

// イベントリスナーの確認
console.error('Event listeners:', this.eventNames());
console.error('Input listeners:', this.listenerCount('input'));
```

## 追加の実装試行（2回目）

### SimpleChatUIの実装

terminal-kitの固定レイアウトの問題を解決するため、よりシンプルなアプローチを試行：

**アーキテクチャ**:
- readline + ANSIエスケープシーケンスの直接使用
- 画面全体を1つの連続した領域として扱う
- 入力欄は常に最下部に「浮いている」状態

**利点**:
- ClaudeCodeに近い自然なレイアウト
- 出力に応じて入力欄が自動的に下に移動
- シンプルで理解しやすい実装

**実装結果**:
- 基本的な動作は実現
- エンター送信が正常に動作
- 日本語表示も可能

### EnhancedChatUIの実装（3回目）

SimpleChatUIをベースに、より高度な機能を追加：

**追加機能**:
1. **複数行入力**
   - 行末に`\`を付けてEnterで改行モード
   - 複数行モードでは空行で送信
   - ClaudeCodeの`\`マーカーを再現

2. **スクロール機能**
   - 上下矢印キーで履歴をスクロール
   - スクロール位置のインジケータ表示
   - 履歴の上限管理（1000行）

3. **ペースト処理（未完成）**
   - 高速な連続入力を検出する仕組みを実装
   - 6行以上は折りたたみ表示の計画
   - **問題**: Raw modeでのペースト検出が困難

4. **日本語入力の改善**
   - バックスペースでの日本語削除を考慮（3バイト単位）
   - 文字幅の正確な計算（CJK文字は2幅）
   - **問題**: IME変換中の状態検出ができない

5. **UI/UXの改善**
   - ウィンドウリサイズ対応
   - 入力欄の動的な高さ調整（最大6行）
   - より洗練されたボーダーデザイン

**現在の課題**:
1. **ペースト検出の問題**
   - Raw modeではOSレベルのペーストイベントを検出できない
   - タイミングベースの検出は信頼性が低い
   - ターミナルエミュレータによって動作が異なる

2. **IME入力の問題**
   - 変換中の状態を検出できない
   - 確定前のテキストが表示されない
   - エンターキーの処理が複雑

3. **Shift+Enterの検出**
   - ターミナルによってエスケープシーケンスが異なる
   - 現在は`\`を末尾に付ける回避策を使用

## 実装の比較

| 機能 | terminal-kit | SimpleChatUI | EnhancedChatUI |
|------|-------------|--------------|----------------|
| 基本レイアウト | ✅固定分割 | ✅自然な流れ | ✅自然な流れ |
| エンター送信 | ❌動作せず | ✅動作 | ✅動作 |
| 日本語表示 | ✅可能 | ✅可能 | ✅可能 |
| 日本語入力 | ❌困難 | ⚠️基本のみ | ⚠️改善済み |
| 複数行入力 | ✅可能 | ❌なし | ✅`\`で可能 |
| スクロール | ✅可能 | ❌なし | ✅矢印キー |
| ペースト | ⚠️検出あり | ❌なし | ⚠️未完成 |
| リサイズ対応 | ✅自動 | ❌なし | ✅自動 |

### ImprovedChatUIの実装（4回目・最終版）

readlineインターフェースを活用した、より実用的な実装：

**アーキテクチャの変更**:
- Raw modeを使わず、readlineインターフェースを活用
- OSレベルのペースト処理を利用
- より安定した入力処理

**実現できた機能**:
1. **完全なペースト対応**
   - 複数行のペーストが正常動作
   - 特別な検出ロジック不要
   - OSネイティブの処理を活用

2. **安定した日本語入力**
   - IMEの動作を妨げない
   - 変換・確定が自然に動作
   - readlineが適切に処理

3. **複数行入力**
   - 行末の`\`で継続
   - 空行で送信
   - 直感的な操作

**制限事項**:
- カスタムキーバインディングが制限される
- 細かいカーソル制御は困難
- しかし、実用上は問題なし

## 実装の最終比較

| 機能 | terminal-kit | SimpleChatUI | EnhancedChatUI | ImprovedChatUI |
|------|-------------|--------------|----------------|----------------|
| 基本レイアウト | ✅固定分割 | ✅自然な流れ | ✅自然な流れ | ✅自然な流れ |
| エンター送信 | ❌動作せず | ✅動作 | ✅動作 | ✅動作 |
| 日本語表示 | ✅可能 | ✅可能 | ✅可能 | ✅可能 |
| 日本語入力 | ❌困難 | ⚠️基本のみ | ⚠️改善済み | ✅完全対応 |
| 複数行入力 | ✅可能 | ❌なし | ✅`\`で可能 | ✅`\`で可能 |
| スクロール | ✅可能 | ❌なし | ✅矢印キー | ⚠️基本のみ |
| ペースト | ⚠️検出あり | ❌なし | ⚠️未完成 | ✅完全対応 |
| リサイズ対応 | ✅自動 | ❌なし | ✅自動 | ✅自動 |
| 実装の複雑さ | 高 | 低 | 中 | 低 |
| 安定性 | 低 | 中 | 中 | 高 |

## 最終結論

1. **ImprovedChatUI（readlineベース）が最適解**
   - ペースト問題を完全解決
   - 日本語入力が自然に動作
   - 実装がシンプルで保守しやすい
   - 実用性が最も高い

2. **ClaudeCode風UIの実現**
   - 画面下部に常に入力欄
   - 出力履歴は上にスクロール
   - 複数行入力のサポート
   - 基本的な要件はすべて満たす

3. **今後の改善案**
   - スクロール機能の追加（PageUp/PageDown）
   - 入力履歴の実装（上下矢印）
   - シンタックスハイライト
   - 自動補完機能

## 実装の教訓

1. **Raw modeの限界**
   - ペースト検出が困難
   - IME処理が複雑
   - ターミナル依存が大きい

2. **readlineの利点**
   - OSレベルの機能を活用
   - 安定した動作
   - 実装がシンプル

3. **ユーザー体験の重要性**
   - 見た目より実用性
   - 安定性が最優先
   - 自然な操作感