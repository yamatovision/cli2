# プロジェクトパス管理リファクタリング: 実装タスクリスト

## 概要

このドキュメントでは、プロジェクトパス管理の単一情報源化を実現するための具体的なタスクを詳細に記載します。「削除」を中心に据え、後方互換性を考慮せず、短期間で完全な移行を目指します。

## フェーズ1: サーバー側実装（VSCode拡張側）

### 1.1 `ProjectManager`クラスの作成

**優先度: 最高**

- [ ] **タスク1.1.1:** `src/services/ProjectManager.ts`ファイルを新規作成
- [ ] **タスク1.1.2:** シングルトンパターンでクラス構造を実装
- [ ] **タスク1.1.3:** `ProjectManagementService`の機能を内部で利用するよう構成
- [ ] **タスク1.1.4:** プロジェクト情報の基本メソッドを実装
  - `getActiveProject()`
  - `getAllProjects()`
  - `getProject(id: string)`
  - `setActiveProject(id: string)`
- [ ] **タスク1.1.5:** プロジェクト操作メソッドを実装
  - `createProject(data: ProjectCreateData)`
  - `removeProject(id: string)`
  - `updateProject(id: string, data: Partial<Project>)`

### 1.2 プロジェクトパス管理の中央集約化

**優先度: 高**

- [ ] **タスク1.2.1:** `ProjectPathUtils`クラスを作成（`src/utils/ProjectPathUtils.ts`）
- [ ] **タスク1.2.2:** パス関連ユーティリティメソッドを実装
  - `normalizePath(path: string)`
  - `ensureAbsolutePath(path: string)`
  - `isValidProjectPath(path: string)`
- [ ] **タスク1.2.3:** 特定プロジェクトファイルのパス取得メソッドを実装
  - `getProgressFilePath(projectPath: string)`
  - `getRequirementsFilePath(projectPath: string)`
  - `getDocsDirectoryPath(projectPath: string)`
  - `getMockupsDirectoryPath(projectPath: string)`
- [ ] **タスク1.2.4:** `ProjectManager`にパスユーティリティ機能を統合
  - `getProjectFilePath(type: string, projectId?: string)`
  - `ensureProjectStructure(projectPath: string)`

### 1.3 WebViewメッセージング統一化

**優先度: 高**

- [ ] **タスク1.3.1:** `ProjectAPICommands`定数オブジェクトを作成（`src/api/ProjectAPICommands.ts`）
- [ ] **タスク1.3.2:** WebViewからの標準リクエスト処理メソッドを実装
  - `handleProjectRequest(message: any): any`
- [ ] **タスク1.3.3:** メッセージハンドラー内でのプロジェクト関連コマンド処理を集約
  - MessageDispatchServiceImplのプロジェクト関連処理をProjectManagerに移管
- [ ] **タスク1.3.4:** 共通レスポンスフォーマットを定義
  - 成功/エラー応答の形式統一

## フェーズ2: クラス実装削除と置き換え

### 2.1 `ProjectServiceImpl`の削除

**優先度: 中**

- [ ] **タスク2.1.1:** `ProjectManager`への依存関係を特定
- [ ] **タスク2.1.2:** `ProjectServiceImpl`の全メソッドで`ProjectManager`を呼び出すように変更
  - 一時的なアダプターとして機能させる
- [ ] **タスク2.1.3:** 内部状態変数をすべて削除
  - `_projectPath`
  - `_progressFilePath`
  - `_currentProjects`
  - `_activeProject`
- [ ] **タスク2.1.4:** 重複するメソッドを削除し`ProjectManager`の同等メソッドを使用
- [ ] **タスク2.1.5:** イベント発火コードを`ProjectManager`に移管

### 2.2 `FileSystemService`の整理

**優先度: 中**

- [ ] **タスク2.2.1:** プロジェクトパス関連のメソッドを特定
  - `getProgressFilePath`
  - `createProgressFile`
  - その他パス依存メソッド
- [ ] **タスク2.2.2:** これらのメソッドを`ProjectPathUtils`に移管
- [ ] **タスク2.2.3:** `FileSystemService`のパス関連メソッドを削除または単純化
- [ ] **タスク2.2.4:** `ProjectManager`からファイル操作を呼び出す方式に変更

### 2.3 イベントシステムの簡素化

**優先度: 中**

- [ ] **タスク2.3.1:** `AppGeniusEventBus`のプロジェクト関連イベントを整理
- [ ] **タスク2.3.2:** 複数のイベントタイプを単一の`PROJECT_CHANGED`イベントに統合
- [ ] **タスク2.3.3:** `ProjectManager`でイベント発火を一元管理
- [ ] **タスク2.3.4:** 冗長なイベントリスナーを削除

## フェーズ3: クライアント側実装（WebView側）

### 3.1 WebViewクライアントラッパーの作成

**優先度: 高**

- [ ] **タスク3.1.1:** `media/utils/projectClient.js`ファイルを新規作成
- [ ] **タスク3.1.2:** VSCodeメッセージング用の標準化されたリクエスト関数を実装
  - `sendProjectRequest(command, params)`
- [ ] **タスク3.1.3:** 各プロジェクト操作のラッパーメソッドを実装
  - `getActiveProjectPath()`
  - `getActiveProject()`
  - `selectProject(name, path)`
  - `getProjectFile(type, projectId)`
- [ ] **タスク3.1.4:** リクエストIDベースのコールバック管理システム実装

### 3.2 `stateManager.js`の修正

**優先度: 高**

- [ ] **タスク3.2.1:** プロジェクト情報の保存に関するコードを削除
  - `activeProjectName`
  - `activeProjectPath`
  - `lastSyncedProjectId`
  - その他プロジェクト関連プロパティ
- [ ] **タスク3.2.2:** 関連メソッドの削除
  - `syncProjectState()`
  - `restoreProjectState()`
- [ ] **タスク3.2.3:** UIの状態管理のみに特化するよう改修
  - `activeTab`など、純粋にUIに関する状態のみを管理
- [ ] **タスク3.2.4:** プロジェクト情報が必要なメソッドは`projectClient`を使用するよう変更

### 3.3 WebView各コンポーネントの修正

#### 3.3.1 `projectNavigation.js`の修正

**優先度: 高**

- [ ] **タスク3.3.1.1:** プロジェクト一覧取得を`projectClient`経由に変更
- [ ] **タスク3.3.1.2:** プロジェクト選択処理を`projectClient.selectProject()`に置き換え
- [ ] **タスク3.3.1.3:** 独自の状態保存コードを削除
- [ ] **タスク3.3.1.4:** プロジェクトパス更新リスナーを`projectClient`のイベントに変更

#### 3.3.2 `fileBrowser.js`の修正

**優先度: 高**

- [ ] **タスク3.3.2.1:** パス管理関連コードを削除
  - `_directoryCache`
  - `currentPath`保存処理
  - パス正規化メソッド
- [ ] **タスク3.3.2.2:** ディレクトリ一覧取得を`projectClient`経由に変更
- [ ] **タスク3.3.2.3:** ファイルパス構築ロジックを削除
- [ ] **タスク3.3.2.4:** プロジェクトパス変更検知方法を`projectClient`に変更

#### 3.3.3 `tabManager.js`の修正

**優先度: 高**

- [ ] **タスク3.3.3.1:** ファイルパス構築コードを削除
- [ ] **タスク3.3.3.2:** タブ操作を`projectClient`経由のメソッドに変更
- [ ] **タスク3.3.3.3:** プロジェクト状態依存のコードを削除
- [ ] **タスク3.3.3.4:** タブ状態のみをローカルで管理するよう変更

#### 3.3.4 その他各コンポーネントの修正

**優先度: 中**

- [ ] **タスク3.3.4.1:** `scopeManager.js`のプロジェクトパス参照コードを変更
- [ ] **タスク3.3.4.2:** `mockupGallery.js`のプロジェクト情報取得を統一
- [ ] **タスク3.3.4.3:** `debugDetective.js`のパス参照を更新
- [ ] **タスク3.3.4.4:** その他コンポーネントをチェックして更新

## フェーズ4: テストと統合

### 4.1 単体テスト

**優先度: 高**

- [ ] **タスク4.1.1:** `ProjectManager`の単体テスト作成
- [ ] **タスク4.1.2:** `ProjectPathUtils`の単体テスト作成
- [ ] **タスク4.1.3:** WebViewメッセージングの単体テスト作成

### 4.2 統合テスト

**優先度: 最高**

- [ ] **タスク4.2.1:** プロジェクト一覧表示テストシナリオ作成
- [ ] **タスク4.2.2:** プロジェクト選択テストシナリオ作成
- [ ] **タスク4.2.3:** ファイルブラウザ動作テストシナリオ作成
- [ ] **タスク4.2.4:** タブ管理テストシナリオ作成
- [ ] **タスク4.2.5:** 進捗状況ファイル編集テストシナリオ作成

### 4.3 回帰テスト

**優先度: 高**

- [ ] **タスク4.3.1:** 全主要機能の動作チェックリスト作成
- [ ] **タスク4.3.2:** エッジケースのテスト
  - 不正なプロジェクトパス
  - 存在しないファイル
  - 同時操作
- [ ] **タスク4.3.3:** 修正前後の動作一致確認

### 4.4 パフォーマンステスト

**優先度: 低**

- [ ] **タスク4.4.1:** 大量プロジェクト存在時の動作検証
- [ ] **タスク4.4.2:** 大きなファイル一覧取得時の速度測定
- [ ] **タスク4.4.3:** VSCodeとWebView間通信の頻度測定

## フェーズ5: クリーンアップと最終化

### 5.1 コード整理

**優先度: 中**

- [ ] **タスク5.1.1:** 使われなくなったコードやファイルを完全削除
- [ ] **タスク5.1.2:** 残存する重複コードの整理
- [ ] **タスク5.1.3:** コメントの更新と機能説明の追加

### 5.2 ドキュメンテーション

**優先度: 中**

- [ ] **タスク5.2.1:** 新しいプロジェクト情報アクセス方法のドキュメント作成
- [ ] **タスク5.2.2:** APIリファレンス作成
- [ ] **タスク5.2.3:** 変更内容の要約書作成

### 5.3 最終検証

**優先度: 最高**

- [ ] **タスク5.3.1:** 全機能の最終チェック
- [ ] **タスク5.3.2:** 未処理のエッジケース確認
- [ ] **タスク5.3.3:** パフォーマンス確認

## 重要なリソース

### 新しいファイル作成

1. `src/services/ProjectManager.ts` - 中央集権的プロジェクト管理
2. `src/utils/ProjectPathUtils.ts` - パス操作ユーティリティ
3. `src/api/ProjectAPICommands.ts` - APIコマンド定義
4. `media/utils/projectClient.js` - WebView側クライアントラッパー

### 主な削除対象

1. `ProjectServiceImpl`の内部状態管理コード
2. `stateManager.js`のプロジェクト関連状態管理
3. 各WebViewコンポーネント内のパス管理コード
4. 冗長なイベント処理コード

## 実装スケジュール目安

| フェーズ | 見積時間 | 依存関係 |
|---------|----------|----------|
| 1.1 | 4-6時間 | なし |
| 1.2 | 3-4時間 | 1.1完了後 |
| 1.3 | 3-4時間 | 1.1, 1.2完了後 |
| 2.1-2.3 | 6-8時間 | フェーズ1完了後 |
| 3.1 | 2-3時間 | 1.3完了後 |
| 3.2 | 2-3時間 | 3.1完了後 |
| 3.3 | 8-12時間 | 3.1, 3.2完了後 |
| 4.1-4.4 | 6-8時間 | フェーズ3完了後 |
| 5.1-5.3 | 4-6時間 | フェーズ4完了後 |

**合計見積時間: 38-54時間**

## 注意事項

1. **一貫した命名規則**を使用する
2. **非同期処理**の扱いに注意する
3. **エラーハンドリング**を適切に実装する
4. フェーズごとに**動作確認**を行う
5. コード削除時は**影響範囲**を事前に確認する

## ロールバック計画

万が一の場合に備え、各フェーズの開始前に該当部分のコードをバックアップしておく。
問題が発生した場合は、フェーズ単位でロールバックし、問題を修正してから再度実装を進める。