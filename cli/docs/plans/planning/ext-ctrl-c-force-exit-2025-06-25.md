# 機能拡張計画: Ctrl+C強制終了機能 2025-06-25

## 1. 拡張概要

BlueLamp CLIに確実で美しいCtrl+C強制終了機能を追加し、同時に複雑で問題のある既存実装を大幅にクリーンアップする。現在のCtrl+C無限ループ問題を根本解決し、ユーザーがターミナル強制終了に頼ることなく、一撃で確実にCLIを終了できる機能を実現する。

## 2. 詳細仕様

### 2.1 現状と課題

**現在の問題：**
- Ctrl+Cで「Pausing the agent...」が無限ループ
- 複数の競合するCtrl+C処理が同時実行
- `process_agent_pause`タスクが重複作成される
- 複雑な非同期クリーンアップが競合状態を引き起こす
- ユーザーはターミナル強制終了以外に脱出方法がない

**技術的根本原因：**
- OSレベルSIGINT、prompt_toolkitキーバインド、カスタムキー監視の3重処理
- エージェント状態変更時の`loop.create_task(process_agent_pause)`重複作成
- `_shutdown_requested`フラグの複雑な管理と競合
- 45個のCTRL+C_DEBUGログによるコード肥大化

### 2.2 拡張内容

**新機能：確実なCtrl+C強制終了**
- Ctrl+C一回押下で即座の強制終了
- 無限ループや重複メッセージの完全排除
- シンプルで理解しやすい終了処理
- 最小限のクリーンアップで確実な終了

**大幅クリーンアップ：**
- 複雑な`_shutdown_requested`機構の削除
- `process_agent_pause`重複作成問題の解決
- 45個のCTRL+C_DEBUGログの削除
- 競合する複数のCtrl+C処理の統一
- 重厚な非同期クリーンアップの簡素化

## 3. ディレクトリ構造

既存ファイルの大幅簡素化（新規ファイル追加なし）

```
openhands/cli/
├── main.py              # 大幅簡素化（602行 → 約400行）
├── tui.py               # process_agent_pause削除・簡素化（736行 → 約600行）
├── commands.py          # 保持（/exitコマンドは維持）
├── interrupt_handler.py # 保持（ESC機能用）
└── その他               # 変更なし
```

## 4. 技術的影響分析

### 4.1 影響範囲

- **フロントエンド**: CLI全体の終了処理
- **バックエンド**: シグナルハンドリング、エージェントループ
- **データモデル**: なし
- **その他**: ログ出力の大幅削減、デバッグ情報の整理

### 4.2 変更が必要なファイル

```
- /openhands/cli/main.py: 複雑なシグナルハンドリングとクリーンアップ処理の簡素化
- /openhands/cli/tui.py: process_agent_pause関数の削除、キーバインド統一
- /openhands/core/loop.py: 終了チェック処理の簡素化
```

## 5. タスクリスト

```
- [ ] **T1**: 複雑な既存実装の削除
  - _shutdown_requested機構の完全削除
  - 45個のCTRL+C_DEBUGログの削除
  - process_agent_pause重複作成ロジックの削除
  - 複雑な非同期クリーンアップ処理の削除

- [ ] **T2**: シンプルなCtrl+C強制終了の実装
  - 単一のSIGINTハンドラーによる即座終了
  - sys.exit(0)による確実な終了処理
  - 最小限のクリーンアップ処理

- [ ] **T3**: キーバインド処理の統一
  - prompt_toolkit内のCtrl+C処理の統一
  - 競合する複数処理の排除
  - ESC機能との明確な分離

- [ ] **T4**: エージェントループの簡素化
  - core/loop.py内の終了チェック簡素化
  - 不要な終了フラグ参照の削除

- [ ] **T5**: テストと検証
  - Ctrl+C一撃終了の動作確認
  - 無限ループ問題の解決確認
  - ESC機能との干渉がないことの確認
```

### 6. テスト計画

**テストケース：**
1. **基本動作テスト**
   - Ctrl+C一回押下で即座終了
   - 「Pausing the agent...」メッセージが一回のみ表示
   - 無限ループが発生しないことの確認

2. **エージェント実行中テスト**
   - エージェント実行中のCtrl+C終了
   - サブエージェント委譲中のCtrl+C終了
   - 長時間実行タスク中のCtrl+C終了

3. **機能分離テスト**
   - ESC機能（タスクキャンセル）との干渉なし
   - /exitコマンドとの併存確認
   - 通常の終了処理との区別確認

4. **クリーンアップテスト**
   - デバッグログの削減確認
   - コード行数の削減確認
   - 処理速度の向上確認

## 7. SCOPE_PROGRESSへの統合

SCOPE_PROGRESS.mdに単体タスクとして統合：

```markdown
- [ ] **CTRL-C-FORCE-EXIT**: Ctrl+C強制終了機能の実装
  - 目標: 2025-07-01
  - 参照: [/docs/plans/planning/ext-ctrl-c-force-exit-2025-06-25.md]
  - 内容: 確実なCtrl+C強制終了機能実装、複雑な既存実装の大幅クリーンアップ
```

## 8. 備考

**設計原則：**
- **単一責任**: Ctrl+Cは強制終了のみに専念
- **シンプル性**: 複雑な状態管理を避け、直接的な処理
- **確実性**: 無限ループや競合状態の完全排除
- **保守性**: 理解しやすく、デバッグしやすいコード

**既存機能との関係：**
- ESC機能（タスクキャンセル）は完全に保持
- /exitコマンドは通常終了として保持
- Ctrl+Cは緊急強制終了として明確に分離

**期待される効果：**
- ユーザビリティの大幅向上
- コードベースの大幅簡素化（約200行削減）
- デバッグログの整理（45個削除）
- 保守性の向上