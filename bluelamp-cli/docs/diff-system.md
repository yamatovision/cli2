# BlueLamp CLI 差分管理システム

## 概要

BlueLamp CLIの差分管理システムは、AIを使用したファイル更新時のトークン使用量を最大70%削減する革新的な機能です。従来のようにファイル全体をAIに送信するのではなく、変更に関連する部分のみを抽出して送信することで、効率的な更新を実現します。

## 主な機能

### 1. 差分プレビュー (`bluelamp diff`)
ファイルの更新前に、どの部分が変更されるかをプレビューできます。

```bash
# 基本的な使用方法
bluelamp diff ./docs/requirements.md --feedback "ユーザー管理機能を追加"

# インタラクティブモード
bluelamp diff ./docs/requirements.md -i
```

### 2. 効率的な更新 (`bluelamp update`)
フィードバックに基づいてファイルを更新します。差分システムにより、トークン使用量を大幅に削減します。

```bash
# 基本的な更新
bluelamp update ./docs/requirements.md --feedback "認証機能の要件を詳細化"

# バックアップなしで別ファイルに出力
bluelamp update ./docs/requirements.md -f "要件を整理" -o ./docs/requirements-v2.md

# ドライラン（実際には変更しない）
bluelamp update ./docs/requirements.md -f "セキュリティ要件を追加" --dry-run
```

### 3. バッチ更新 (`bluelamp update batch`)
複数のファイルに同じフィードバックを適用します。

```bash
# すべてのMarkdownファイルを更新
bluelamp update batch "docs/**/*.md" -f "日本語の表現を改善"

# ドライランで確認
bluelamp update batch "src/**/*.ts" -f "TypeScriptの型定義を厳密化" --dry-run
```

### 4. 履歴管理 (`bluelamp history`)
過去の更新履歴を確認できます。

```bash
# すべての履歴を表示
bluelamp history

# 特定ファイルの履歴のみ表示
bluelamp history ./docs/requirements.md

# 差分コマンドからも履歴を確認
bluelamp diff history ./docs/requirements.md
```

## 仕組み

### 差分エンジン
1. **コンテキスト抽出**: フィードバックに関連する行を自動的に特定
2. **セクション生成**: 変更箇所の前後数行を含むコンテキストセクションを作成
3. **トークン最適化**: 必要最小限の情報のみをAIに送信

### パッチ適用
1. **構造化レスポンス**: AIからJSON形式で変更指示を受信
2. **変更の検証**: 行番号と内容の整合性をチェック
3. **安全な適用**: バックアップを作成してから変更を適用

## トークン削減の例

### 従来の方法
```
ファイル全体（1000行）→ AIに送信 → 約4000トークン
```

### 差分システム
```
関連セクション（50行）+ 指示 → AIに送信 → 約1200トークン（70%削減）
```

## 設定とカスタマイズ

### コンテキスト行数の調整
デフォルトでは変更箇所の前後3行をコンテキストとして含めますが、これは調整可能です。

### 履歴の管理
履歴は `.bluelamp/diff-history.json` に保存され、最新100件まで保持されます。

## ベストプラクティス

1. **明確なフィードバック**: 具体的で明確なフィードバックを提供することで、より正確な変更が可能
2. **プレビューの活用**: 重要な変更の前は必ずプレビューで確認
3. **バックアップ**: 自動バックアップ機能を活用し、必要に応じて手動バックアップも作成
4. **バッチ更新の注意**: 複数ファイルへの一括適用は慎重に

## トラブルシューティング

### エラー: "Overlapping changes"
複数の変更が同じ行に競合している場合に発生します。フィードバックを調整して、変更箇所を明確に分離してください。

### エラー: "No valid JSON response found"
AIからの応答が正しいJSON形式でない場合に発生します。フィードバックをより具体的にしてください。

### トークン削減率が低い
ファイルが小さい、または変更箇所が分散している場合は削減率が低くなることがあります。これは正常な動作です。