# ScopeManagerサービスリファクタリング実装ロードマップ

## 概要

このロードマップは、ScopeManagerのサービス責任分割実装プランに基づき、プロジェクト切り替え処理を中心としたリファクタリングの実施スケジュールと優先順位を定義するものです。実装は段階的に行い、各フェーズでテストを実施して機能の退行を防止します。

## 優先順位の基準

リファクタリングの優先順位は以下の基準で決定しています：

1. **基盤となるサービス**: 他のサービスが依存するコアサービスを先に改修
2. **影響範囲**: 変更による影響範囲が小さいものから取り組む 
3. **リスク**: テスト困難度や失敗時の影響を考慮
4. **期待効果**: パフォーマンス向上や保守性改善の効果が大きいものを優先

## 実装ロードマップ

### フェーズ1: 準備と基盤構築（2025-05-10 〜 2025-05-12）

| タスク | 担当者 | 開始日 | 終了日 | 優先度 | 依存関係 | 
|-------|-------|-------|-------|-------|--------|
| サービスインターフェース定義の作成 | Team A | 2025-05-10 | 2025-05-11 | 高 | なし |
| ServiceRegistry強化実装 | Team A | 2025-05-11 | 2025-05-12 | 高 | サービスインターフェース定義 |
| EventBus実装の強化 | Team B | 2025-05-11 | 2025-05-12 | 中 | なし |
| 単体テスト環境構築 | Team C | 2025-05-10 | 2025-05-11 | 高 | なし |

**フェーズ1の成果物**:
- 型安全なサービスインターフェース定義（IFileSystemService, IProjectService など）
- 強化されたServiceRegistry（型安全なサービス登録と取得）
- 型安全なEventBus実装
- サービス単体テスト用の環境とモック

### フェーズ2: コアサービスのリファクタリング（2025-05-12 〜 2025-05-16）

| タスク | 担当者 | 開始日 | 終了日 | 優先度 | 依存関係 | 
|-------|-------|-------|-------|-------|--------|
| FileSystemServiceリファクタリング | Team A | 2025-05-12 | 2025-05-14 | 高 | フェーズ1完了 |
| FileSystemService単体テスト | Team A | 2025-05-13 | 2025-05-14 | 高 | FileSystemService実装開始 |
| ProjectServiceリファクタリング | Team B | 2025-05-14 | 2025-05-16 | 高 | FileSystemService完了 |
| ProjectService単体テスト | Team B | 2025-05-15 | 2025-05-16 | 高 | ProjectService実装開始 |

**フェーズ2の成果物**:
- ファイル操作を一元管理するFileSystemService
- プロジェクト状態管理を一元化したProjectService
- 各サービスの単体テスト
- 基本的な統合テスト

### フェーズ3: UI関連サービスのリファクタリング（2025-05-16 〜 2025-05-20）

| タスク | 担当者 | 開始日 | 終了日 | 優先度 | 依存関係 | 
|-------|-------|-------|-------|-------|--------|
| TabStateServiceリファクタリング | Team A | 2025-05-16 | 2025-05-17 | 中 | ProjectService完了 |
| TabStateService単体テスト | Team A | 2025-05-17 | 2025-05-18 | 中 | TabStateService実装開始 |
| PanelServiceリファクタリング | Team C | 2025-05-17 | 2025-05-19 | 高 | TabStateService開始 |
| PanelService単体テスト | Team C | 2025-05-18 | 2025-05-19 | 高 | PanelService実装開始 |
| MessageDispatchServiceリファクタリング | Team B | 2025-05-18 | 2025-05-20 | 高 | PanelService開始 |
| MessageDispatchService単体テスト | Team B | 2025-05-19 | 2025-05-20 | 高 | MessageDispatchService実装開始 |

**フェーズ3の成果物**:
- タブ状態管理に特化したTabStateService
- WebViewとの通信を一元管理するPanelService
- メッセージルーティングに特化したMessageDispatchService
- 各サービスの単体テスト
- サービス間連携の統合テスト

### フェーズ4: 統合と検証（2025-05-20 〜 2025-05-23）

| タスク | 担当者 | 開始日 | 終了日 | 優先度 | 依存関係 | 
|-------|-------|-------|-------|-------|--------|
| プロジェクト切り替えフロー統合テスト | Team A+B | 2025-05-20 | 2025-05-21 | 最高 | すべてのサービス完了 |
| パフォーマンス計測と最適化 | Team C | 2025-05-21 | 2025-05-22 | 高 | 統合テスト開始 |
| エッジケーステスト | Team A+B | 2025-05-21 | 2025-05-22 | 中 | 統合テスト開始 |
| WebView側の対応実装 | Team C | 2025-05-22 | 2025-05-23 | 高 | 統合テスト完了 |
| ドキュメント更新 | All | 2025-05-22 | 2025-05-23 | 中 | すべての実装完了 |

**フェーズ4の成果物**:
- プロジェクト切り替えフローの完全な統合テスト
- パフォーマンス計測結果と最適化
- エッジケースのテスト結果と対応
- WebView側の対応実装
- 更新されたドキュメント

## 詳細タスク説明

### FileSystemServiceリファクタリング

**目的**:
すべてのファイル操作を一元管理し、重複ファイル読み込みを排除する。

**主要タスク**:
1. ファイル読み込み関連メソッドの集約と標準化
   ```typescript
   readFile(path: string): Promise<string>
   readMarkdownFile(path: string): Promise<string>
   fileExists(path: string): Promise<boolean>
   ```

2. ファイル監視機能の実装
   ```typescript
   setupProjectWatchers(projectPath: string): Promise<void>
   onFileChanged(callback: (filePath: string) => void): void
   ```

3. ディレクトリ操作の集約
   ```typescript
   getDirectoryStructure(rootPath: string): Promise<DirectoryStructure>
   ```

4. マークダウン特化処理の実装（オプショナル）
   ```typescript
   parseMarkdownContent(content: string): MarkdownStructure
   ```

### ProjectServiceリファクタリング

**目的**:
プロジェクト状態管理を一元化し、イベントベースの状態通知を導入する。

**主要タスク**:
1. プロジェクト選択ロジックの最適化
   ```typescript
   selectProject(name: string, path: string, activeTab?: string): Promise<boolean>
   ```

2. プロジェクトメタデータ管理の改善
   ```typescript
   getActiveProject(): Project | null
   getProjectByPath(path: string): Project | null
   getAllProjects(): Project[]
   ```

3. イベント発行メカニズムの導入
   ```typescript
   emitProjectSelectedEvent(name: string, path: string): void
   ```

4. ファイルシステムイベント購読の実装
   ```typescript
   private _handleFileChange(filePath: string): void
   ```

### PanelServiceリファクタリング

**目的**:
WebViewとの通信を一元化し、UI更新メッセージを効率化する。

**主要タスク**:
1. 包括的な状態更新送信メソッドの実装
   ```typescript
   syncFullProjectState(state: ProjectUIState): void
   ```

2. イベント購読メカニズムの実装
   ```typescript
   private _setupEventListeners(): void
   ```

3. パネル初期化処理の最適化
   ```typescript
   initializePanel(): Promise<void>
   ```

4. エラーハンドリングの一元化
   ```typescript
   showError(message: string): void
   showSuccess(message: string): void
   ```

### MessageDispatchServiceリファクタリング

**目的**:
責任範囲をメッセージルーティングに限定し、適切なサービス委譲を実装する。

**主要タスク**:
1. メッセージハンドラ登録メカニズムの改善
   ```typescript
   registerMessageHandlers(): void
   ```

2. WebViewからのメッセージ処理の集約
   ```typescript
   handleMessage(message: any): void
   ```

3. サービス委譲パターンの実装
   ```typescript
   private _registerProjectHandlers(): void
   private _registerFileHandlers(): void
   ```

4. エラーハンドリングの標準化
   ```typescript
   private _handleError(operation: string, error: Error): boolean
   ```

## リスク管理計画

| リスク | 確率 | 影響 | 重要度 | 対策 |
|-------|------|------|-------|------|
| 既存機能の退行 | 中 | 高 | 高 | 既存動作を記録、自動テスト作成、段階的リリース |
| リファクタリング中の新機能要求 | 高 | 中 | 中 | ブランチ戦略の明確化、変更窓口の一元化 |
| 想定外の依存関係 | 中 | 高 | 高 | 事前の依存関係の詳細分析、変更の影響範囲調査 |
| パフォーマンス低下 | 低 | 高 | 中 | 各段階でのパフォーマンス測定、ベンチマーク比較 |
| WebView側の対応遅延 | 中 | 高 | 高 | 初期段階からのWebView開発者との協業、バックアップ互換性の維持 |

## パフォーマンス測定計画

リファクタリング前後でパフォーマンスを比較するための測定計画:

1. **測定対象操作**
   - プロジェクト初期化時間
   - プロジェクト切り替え時間
   - ファイル読み込み回数
   - メッセージ送信回数
   - メモリ使用量

2. **測定方法**
   - ログベースのタイミング記録
   - プロファイリングツールの使用
   - カウンターによるメッセージと操作の計数
   - 自動テストによる一貫した再現性の確保

3. **成功基準**
   - プロジェクト切り替え時間: 40%以上の短縮
   - ファイル読み込み: 重複読み込みの完全除去
   - メッセージ数: 50%以上の削減
   - メモリ使用量: 10%以上の削減
   - エラーケース: 適切なエラーハンドリングの100%実施

## 移行戦略

リファクタリングの移行は以下の戦略で進めます:

1. **フィーチャーフラグ方式**
   - 新旧実装を並行維持し、フラグで切り替え可能に
   - 段階的に新実装への移行を進める
   - 問題発生時は即座に旧実装へ切り戻し可能

2. **バックワード互換性**
   - 既存のメッセージ形式もサポート
   - 新形式と旧形式の橋渡しレイヤーを用意

3. **段階的リリース**
   - 内部開発者向けに先行リリース
   - フィードバック収集と改善
   - 全ユーザー向けリリース

## まとめ

このロードマップに従って実装を進めることで、約2週間でScopeManagerのサービス責任分割とプロジェクト切り替えフローの最適化を実現できます。各フェーズでの確実なテストと段階的アプローチにより、リスクを最小限に抑えながら大幅な改善を達成します。

最終的に、コードの保守性向上、パフォーマンスの改善、エラー処理の堅牢化を実現し、将来の機能拡張の基盤を整えます。