# BlueLamp CLI 要件定義書 v2.0

**バージョン**: 2.3.0  
**最終更新日**: 2025-06-19  
**ステータス**: 実装完了・複数行入力対応済み  

## 1. プロジェクト概要

### 1.1 目的と背景

BlueLamp CLIは、HTTPプロンプト取得とClaudeCodeライクなツール統合により、シンプルで強力な開発支援を行うコマンドラインツールです。従来の複雑なエージェント分割を廃止し、単一エントリーポイント + 長期会話セッション + 汎用ツールによるClaudeCode風のアーキテクチャを採用しています。

### 1.2 ターゲットユーザー

- **主要ユーザー**: 開発者・プロジェクトマネージャー
- **技術レベル**: 基本的なCLI操作ができるユーザー

### 1.3 核となる機能と価値

- **HTTPプロンプト取得**: 動的なプロンプト更新によるアジリティ向上 - *この機能がないと柔軟性が失われる*
- **20万コンテクスト会話**: 長期セッションによる文脈保持 - *この機能がないと会話の継続性が失われる*
- **ClaudeCodeライクツール**: read/write/edit/bashによる汎用操作 - *この機能がないと実用性が大幅に低下*
- **シンプルアーキテクチャ**: 単一ファイル267行の軽量実装 - *この機能がないと保守性が悪化*

## 2. システムアーキテクチャ

### 2.1 シンプルアーキテクチャ概要

```
[ユーザー]
    ↓
[BlueLamp CLI] (単一エントリーポイント)
    ↓
[HTTPプロンプト取得] → [Claude API (20万コンテクスト)]
    ↓
[ツール統合実行] → [read/write/edit/bash]
    ↓
[ファイル操作・実行結果]
```

### 2.2 ディレクトリ構造

```
bluelamp-cli/
├── src/
│   └── index.ts                # 単一実装ファイル (267行)
├── dist/
│   └── index.js                # ビルド出力
├── package.json                # 最小限の依存関係
└── tsconfig.json               # TypeScript設定
```

## 3. 機能要件

### 3.1 コアコマンド

| コマンド | 説明 | 実装状況 |
|---------|------|---------|
| `bluelamp` | 単一エントリーポイント・REPL開始 | ✅ 完了 |

### 3.2 基本動作フロー

```bash
# 1. HTTPプロンプト取得 + Claude API セッション開始
bluelamp

# 2. Claude との対話 (20万コンテクストまで継続可能)
あなた: タスク管理アプリの要件定義を作成して
Claude: [read tool] で既存ファイル確認 → [write tool] で要件定義書作成

# 3. ツールを使った自動ファイル操作
あなた: その要件に基づいてHTMLモックアップを作成して  
Claude: [read tool] 要件定義読み込み → [write tool] モックアップ作成

# 4. 差分編集やbash実行
あなた: ボタンを大きくして
Claude: [edit tool] でCSS修正

# 5. 終了
あなた: exit
```

### 3.3 ツール仕様

#### 3.3.1 Read Tool
```typescript
// ファイル内容を読み取り
await readFile(filePath: string): Promise<string>
```

#### 3.3.2 Write Tool（ClaudeCode風強化版）
```typescript
// ファイルを作成・上書き + 自動ディレクトリ作成
await writeFile(filePath: string, content: string): Promise<string>

// 新機能:
// - ディレクトリが存在しない場合は自動作成（mkdir -p相当）
// - 権限エラー回避（絶対パス→相対パス自動変換）
// - ClaudeCode風の柔軟なファイル操作
```

#### 3.3.3 Edit Tool
```typescript  
// ファイルの一部を置換編集
await editFile(filePath: string, oldText: string, newText: string): Promise<string>
```

#### 3.3.4 Bash Tool
```typescript
// bashコマンドを実行
await execBash(command: string): Promise<string>
```

## 4. 技術仕様

### 4.1 HTTPプロンプト取得

```typescript
const PROMPT_URL = 'http://bluelamp-235426778039.asia-northeast1.run.app/api/prompts/public/cdc2b284c05ebaae2bc9eb1f3047aa39';

async fetchPrompt() {
  const response = await fetch(PROMPT_URL);
  this.systemPrompt = await response.text();
}
```

### 4.2 Claude API設定

```typescript
const MODEL = 'claude-sonnet-4-20250514';
const response = await this.client.messages.create({
  model: MODEL,
  max_tokens: 64000,  // 最大出力トークン（長文ドキュメント対応）
  temperature: 0.7,
  system: this.systemPrompt,
  messages: this.messages,
  tools: tools
});
// 20万コンテクストを最大限活用
// 64000トークン出力で長文生成可能
// ツール統合によるClaudeCodeライクな汎用性
```

### 4.3 依存関係（最小限）

```json
{
  "dependencies": {
    "@anthropic-ai/sdk": "^0.24.3",
    "chalk": "^5.4.1", 
    "dotenv": "^16.4.5",
    "inquirer": "^12.6.3"
  }
}
```

## 5. 実装状況

### ✅ 完了済み項目
- **単一エントリーポイント**: `bluelamp` コマンド
- **HTTPプロンプト取得**: 動的プロンプト読み込み（要件定義クリエイター「レコンX」）
- **20万コンテクスト会話**: 長期セッション対応
- **64000トークン出力**: 長文ドキュメント生成対応
- **ツール統合**: read/write/edit/bash の4ツール
- **ClaudeCode風write機能**: 自動ディレクトリ作成 + 権限エラー回避
- **デバッグ機能**: ツール実行時の詳細ログ表示
- **シンプルアーキテクチャ**: 単一ファイル実装
- **依存関係最小化**: 4パッケージのみ

### ❌ 削除された複雑な要素
- 複雑なエージェント分割 (requirements/mockup/data-model等)
- 複雑なコマンド構造 (--new, --update, --interactive等)
- 不要な依存関係 (commander, diff, glob, ora等)
- 複雑なディレクトリ構造 (agents/, core/, diff/, lib/等)

## 6. セキュリティ考慮事項

1. **API認証**
   - ANTHROPIC_API_KEY による認証
   - 環境変数での安全な管理

2. **ファイル操作**
   - read/write/edit ツールの適切な実装
   - パストラバーサル対策

3. **bash実行**
   - 実行結果の適切な処理
   - エラーハンドリング

## 7. 成功指標

1. **シンプルさ**
   - 実装行数: 単一ファイル（従来の1/10以下）
   - 依存関係: 4パッケージ（従来の1/2以下）
   - 学習コスト: 5分以内で操作開始

2. **パフォーマンス**
   - 起動時間: 2秒以内
   - HTTPプロンプト取得: 1秒以内
   - 20万コンテクスト活用による長期対話
   - 64000トークン出力による長文生成

3. **ユーザビリティ**
   - ClaudeCodeライクな直感的操作
   - 自動ディレクトリ作成によるシームレスなファイル操作
   - ツール統合による汎用性
   - 単一コマンドによる簡単さ
   - 権限エラー自動回避

## 8. 将来の拡張計画

1. **プロンプトURL設定機能**
   - 環境変数でのプロンプトURL変更
   - 複数プロンプトの選択機能

2. **ツール拡張**
   - 追加ツールの実装
   - プラグインシステム検討

3. **AppGeniusプラットフォーム統合**
   - VSCode拡張からの呼び出し
   - ポータルとの連携

## 9. 最新の実装成果（v2.3.0）

### 🎉 2025-06-19 複数行入力問題の解決

#### ✅ 改行問題の根本原因特定と解決
- **問題**: 従来のreadline実装では改行で入力が切れる
- **原因**: 対話型CLIの標準的な制限（Enter = 送信）
- **解決**: Ctrl+D（EOF）方式による複数行入力対応

#### ✅ 長文コピペ対応の実現
```bash
# 複数行を含む長文のコピペが可能に
bluelamp
あなた: (Ctrl+D で送信, "exit" で終了)
[長文をペースト]
[Ctrl+D押下]
# → 改行を含む全文が正しく送信される
```

#### ✅ RYT接続切断問題の解決過程
1. **初期仮説**: 文字数制限 → 実際は改行が原因
2. **試行錯誤**: 
   - 一時ファイル作成方式 → readツール依存で複雑
   - ボックスモード → 表示崩れで断念
   - Bracketed Paste Mode → ターミナル依存で不安定
3. **最終解決**: Ctrl+D方式でシンプルに解決

### 🚧 既知の制限事項と今後の課題

#### 現在の制限
1. **Ctrl+D必須**: 送信にCtrl+D操作が必要
2. **単一行表示**: プロンプトが最初の行のみ
3. **空行処理**: Ctrl+Dのみで空入力になる

#### 今後のUI/UX改善課題
1. **プロンプト表示の改善**
   - 各行にプロンプト記号を表示
   - 入力中であることを視覚的に示す

2. **ClaudeCode風の入力体験**
   - ペースト検出による自動処理
   - プレースホルダー表示機能

3. **エラーハンドリング**
   - 誤操作防止機能
   - より直感的な操作ガイド

### 🏆 v2.3.0で達成された目標

- **✅ 複数行入力対応**: Ctrl+D方式で安定動作
- **✅ 長文コピペ**: 改行を含む文書の完全サポート
- **✅ RYT接続安定性**: 長文でも切断されない
- **✅ 既存機能の維持**: 全ツール機能は正常動作

### 📊 技術的な学び

1. **対話型CLIの本質的制限**
   - 改行 = Enter = 送信という基本設計
   - 複数行入力は特殊な実装が必要

2. **ClaudeCodeの高度な実装**
   - VSCode統合による特殊なUI
   - 標準的なCLIとは異なるアプローチ

3. **シンプルな解決策の重要性**
   - 複雑な実装より標準的な方法（Ctrl+D）が安定

---

**実装完了**: BlueLamp CLIは複数行入力に対応し、より実用的なツールに進化しました。今後はUI/UXの改善により、さらに使いやすいツールを目指します。