# 機能拡張計画: ESCキー割り込み機能 2025-06-28

## 1. 拡張概要

ClaudeCodeのように、ESCキーを押すことでAIの実行を即座に中断し、ユーザーの話を聞ける状態にする機能を実装する。現在実行中のタスクは完了させてから、残りの予定タスクをキャンセルし、ユーザー入力待ち状態に復帰する。

## 2. 詳細仕様

### 2.1 現状と課題

現在のOpenHands CLIモードでは：
- Ctrl+Cでアプリケーション全体のシャットダウンは可能
- ESCキーの基本処理はあるが、単純な例外発生のみ
- AIが長時間のタスクを実行中に、ユーザーが途中で方向転換したい場合の手段がない
- タスクの途中キャンセル機能が不足している

### 2.2 拡張内容

ESCキーによる割り込み機能の実装：
1. **即座の割り込み検出**: ターミナルがアクティブな状態でESCキー押下を検出
2. **現在タスクの完了待機**: 実行中のタスクは完了させる（データ整合性確保）
3. **残りタスクのキャンセル**: 予定されていた後続タスクをすべてキャンセル
4. **状態復帰**: ユーザー入力待ち状態に即座に復帰
5. **視覚的フィードバック**: 「ユーザーによってキャンセルされました。」メッセージ表示
6. **新規タスク開始**: 完全に新しいタスクとして次の指示を受け付け

## 3. ディレクトリ構造

```
openhands/
├── cli/
│   ├── interrupt_handler.py          # 新規: ESC割り込み専用処理
│   ├── tui.py                        # 変更: ESCキー処理拡張
│   └── main.py                       # 変更: 割り込みフラグ追加
├── core/
│   └── loop.py                       # 変更: 割り込みチェック追加
└── events/action/
    └── agent.py                      # 参照: 既存の状態変更アクション使用
```

## 4. 技術的影響分析

### 4.1 影響範囲

- **CLI**: ESCキー処理の拡張、割り込みフラグ管理
- **エージェント制御**: 実行ループでの割り込みチェック
- **イベントシステム**: 既存の状態変更アクションを活用
- **UI/UX**: 割り込み時のメッセージ表示

### 4.2 変更が必要なファイル

```
- openhands/cli/interrupt_handler.py: ESC割り込み専用処理クラス
- openhands/cli/tui.py: process_agent_pause()関数にESC処理追加
- openhands/cli/main.py: _user_interrupt_requested フラグ追加
- openhands/core/loop.py: run_agent_until_done()に割り込みチェック追加
```

## 5. タスクリスト

```
- [ ] **T1**: 割り込みハンドラーの実装
- [ ] **T2**: ESCキー処理の拡張
- [ ] **T3**: メインループでの割り込みフラグ管理
- [ ] **T4**: エージェント実行ループでの割り込みチェック
- [ ] **T5**: UI表示とメッセージ処理
- [ ] **T6**: テストとデバッグ
```

## 6. テスト計画

以下のシナリオでテストを実施：
1. **基本動作**: ESCキー押下でタスクが適切にキャンセルされる
2. **タスク完了待機**: 実行中のタスクが完了してからキャンセルされる
3. **状態復帰**: ユーザー入力待ち状態に正しく復帰する
4. **メッセージ表示**: 適切なフィードバックメッセージが表示される
5. **新規タスク開始**: キャンセル後に新しいタスクが正常に開始できる
6. **エラーハンドリング**: 異常状態での割り込み処理

## 7. SCOPE_PROGRESSへの統合

SCOPE_PROGRESS.mdに以下のタスクとして統合：

```markdown
- [ ] **ESC-INTERRUPT**: ESCキー割り込み機能の実装
  - 目標: 2025-07-01
  - 参照: [/docs/plans/planning/ext-esc-interrupt-2025-06-28.md]
  - 内容: ClaudeCode風のESCキー割り込み機能実装、現在タスク完了後の残りタスクキャンセル
```

## 8. 備考

- 既存のCtrl+C処理（アプリケーション終了）とは独立した機能として実装
- 現在のシャットダウンフラグパターンを参考に、安全な実装を行う
- ファイル編集などの途中状態は保持される（編集途中の内容も含めて保存）
- 実装は既存のアーキテクチャを最大限活用し、最小限の変更で実現