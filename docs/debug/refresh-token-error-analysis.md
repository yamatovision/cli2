# リフレッシュトークンエラー分析レポート

## エラー概要
- **発生日時**: 2025-05-23 07:41:30 - 07:54:30
- **エラー**: 401 Unauthorized - "無効なリフレッシュトークンです"
- **エンドポイント**: `POST https://bluelamp-235426778039.asia-northeast1.run.app/api/simple/auth/refresh-token`
- **頻度**: 毎分発生（定期的なトークン更新処理）
- **最終結果**: 認証状態がクリアされた

## エラー分析の依存関係

### 1. フロントエンド（VSCode拡張機能）
```
SimpleAuthService.ts
├── _refreshAccessToken() - リフレッシュトークンを送信
├── _retryApiCall() - リトライ処理
├── verifyAuthState() - 定期的な認証チェック
└── AuthStorageManager.ts - トークン保存/取得
```

### 2. バックエンド（Portal）
```
simpleAuth.controller.js
├── refreshToken() - トークンリフレッシュ処理
├── SimpleUser.model - ユーザーとトークンの関連付け
└── simpleAuth.helper.js - トークン生成/検証
```

## 問題の特定

### 1. エラーパターン
- エラーは即座に発生（ERR_BAD_REQUEST）
- 毎回4回のリトライが実行される
- 13分間継続後、認証状態がクリアされる

### 2. 考えられる原因

#### A. トークンの不一致
- DBに保存されているリフレッシュトークンと送信されたトークンが一致しない
- ユーザーが複数デバイスでログインし、トークンが上書きされた

#### B. トークンの有効期限
- リフレッシュトークンの有効期限が切れている（7日間）
- JWT検証でTokenExpiredErrorが発生

#### C. ユーザーステータス
- ユーザーのstatusが'active'でない
- ユーザーが削除されている

#### D. データベースの問題
- MongoDBの接続問題
- トークン保存時のエラー

## デバッグ手順

### ステップ1: トークンの保存状態を確認
```javascript
// VSCode拡張機能側
// トークンがAuthStorageManagerに正しく保存されているか確認
```

### ステップ2: バックエンドのログを確認
```javascript
// simpleAuth.controller.js:178-272
// リフレッシュトークン処理のログ出力を確認
console.log('refreshToken: リフレッシュトークン処理開始');
console.log('refreshToken: トークン検証開始');
console.log('refreshToken: ユーザー検索開始');
```

### ステップ3: トークン検証の詳細を追加
```javascript
// リフレッシュトークンの詳細をログに出力
// - トークンの最初の10文字
// - デコード結果
// - ユーザー検索結果
```

## 推奨される改善点

### 1. エラーハンドリングの改善
- より詳細なエラーメッセージを返す
- エラーコードを細分化（期限切れ、無効、ユーザー不在など）

### 2. トークン管理の強化
- リフレッシュトークンのローテーション戦略の見直し
- 複数デバイス対応の実装

### 3. ログ出力の改善
- フロントエンドでトークンの一部をログ出力
- バックエンドでより詳細なデバッグ情報を記録

### 4. リトライロジックの最適化
- 401エラーの場合はリトライを行わない
- エラー種別に応じた処理の分岐