# マークダウンパーサー 処理差異分析レポート

## 1. 概要

AppGeniusにおけるマークダウンパーサーの実装について、「要件定義・進捗状況表示」と「ファイルビューア表示」で異なる見た目になっている原因を分析し、統一化するための対策を検討します。

## 2. 各ビューで使用されているマークダウンパーサー

### 2.1 要件定義・進捗状況表示のパーサー

**担当ファイル:**
- `/media/utils/simpleMarkdownConverter.js` - コアの変換ロジック
- `/media/utils/markdownConverter.js` - `simpleMarkdownConverter.js`への委譲
- `/src/utils/MarkdownParser.ts` - サーバーサイドでの変換（最近統一化されたもの）

**処理フロー:**
1. スコープマネージャーパネルがマークダウンテキストを取得
2. `media/components/markdownViewer/markdownViewer.js`が`simpleMarkdownConverter.js`の`convertMarkdownToHtml`を呼び出す
3. HTMLに変換されたマークダウンがUI上でレンダリングされる

### 2.2 マークダウンファイルビューアのパーサー

**担当ファイル:**
- `/src/ui/markdownViewer/MarkdownViewerPanel.ts` - ビューアパネルのロジック
- `/media/markdownViewer/js/markdownViewer.js` - WebViewフロントエンド
- `/media/markdownViewer/template.html` - WebViewテンプレート

**処理フロー:**
1. `MarkdownViewerPanel`がWebViewパネルを作成し、マークダウンファイルを読み込む
2. `markdownViewer.js`内で`simpleMarkdownConverter`のインポートを試みるが、正しく読み込まれていない可能性
3. フォールバックとして内部の`convertMarkdownToHtml`関数を使用している

## 3. 検出された差異

### 3.1 変換ロジックの差異

| 要素 | 要件定義・進捗状況表示 | マークダウンファイルビューア |
|------|------------------------|--------------------------|
| 見出し | インラインスタイル付きHTMLタグ<br>`<h1 style="font-size:2em; margin-top:1.2em; ...">` | シンプルなHTMLタグ<br>`<h1>` |
| 太字 | `<span style="font-weight:700; color:#003366;">` | `<strong>` |
| コードブロック | スタイル付き`<pre><code>`タグ | シンプルな`<pre><code>`タグ |
| 段落 | `<div class="md-line">` | `<p>` |
| テーブル | 複雑なレンダリングロジック | シンプル変換またはサポートされていない |

### 3.2 スタイル適用の差異

1. **要件定義・進捗状況表示:**
   - インラインスタイルを多用（色、マージン、パディング、ボーダーなど）
   - VSCodeテーマ変数を参照（例：`var(--vscode-panel-border)`）
   - コードブロックには特別なスタイル（背景色、シャドウなど）

2. **マークダウンファイルビューア:**
   - 最小限のスタイル適用
   - デフォルトのHTMLタグスタイルに依存
   - 独自のフォールバック変換関数を使用

### 3.3 コアの問題点

1. **インポートの問題:**
   - `markdownViewer.js`で`simpleMarkdownConverter.js`の読み込みが期待通りに動作していない可能性
   - 読み込みに失敗すると内部のシンプルな変換関数にフォールバックする

2. **スタイル指定の違い:**
   - 要件定義・進捗状況表示では豊富なインラインスタイルを使用
   - マークダウンファイルビューアではシンプルなHTMLタグに依存

3. **テンプレート差異:**
   - 異なるHTMLテンプレートを使用している

## 4. 解決策の提案

### 4.1 短期的解決策

1. **WebViewのロード方式の修正:**
   - `MarkdownViewerPanel`内で`mdConverterUri`が正しく設定されていることを確認
   - WebViewのHTML読み込みタイミングとスクリプト読み込みタイミングの同期

2. **フォールバックメカニズムの確認:**
   - `markdownViewer.js`の79-80行目にある条件文を確認し、デバッグログを追加してコンバーターが正しくロードされているか検証

3. **明示的なスタイル統一:**
   - マークダウンビューアのCSSを要件定義・進捗状況表示と同じスタイルに統一

### 4.2 長期的解決策

1. **単一変換コンポーネントの作成:**
   - アプリケーション全体で使用する単一のマークダウン変換モジュールを設計
   - 異なるビューでの使用をサポートする柔軟なAPIを提供

2. **スタイル定義の分離:**
   - インラインスタイルからCSSクラスベースのスタイリングに移行
   - 統一されたテーマを適用

3. **テスト強化:**
   - 異なるマークダウン要素のレンダリング結果を検証するテストを追加

## 5. 実装優先度

1. `markdownViewer.js`内でのコンバーター読み込みの修正
2. WebViewテンプレートの更新
3. CSSスタイルの統一
4. 変換ロジックの検証と統一

## 6. 結論

マークダウンパーサーの差異は主にフロントエンドの実装とスタイル適用の違いによるものです。バックエンド側（`MarkdownParser.ts`）は既に統一されていますが、フロントエンドでの表示方法が異なっています。解決策としては、WebViewでの`simpleMarkdownConverter.js`の正しい読み込みと、共通スタイルの適用を確認することが重要です。